<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CHESS ARENA for PI — FIDE Legal (Auto-Queen Promotion)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--bg:#111;--fg:#eee;--light:#f0f0f0;--dark:#b1e59f;--sel:#ffcc00;--hint:#5ac8fa;--accent:#f4b400;--warn:#ff5252}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Arial;display:flex;flex-direction:column;align-items:center;padding:16px}
h1{margin:6px 0 2px;font-size:20px}
.sub{opacity:.75;font-size:12px;margin-bottom:8px}
.wrap{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;justify-content:center;width:100%;max-width:1100px}
#board{display:grid;grid-template-columns:repeat(8,min(10.5vw,66px));grid-template-rows:repeat(8,min(10.5vw,66px));border:6px solid #333;border-radius:10px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.45)}
.sq{display:flex;align-items:center;justify-content:center;font-size:min(8vw,50px);cursor:pointer}
.sq.light{background:var(--light)}.sq.dark{background:var(--dark)}
.piece.white{color:#b8860b;text-shadow:2px 2px 0 #000;font-weight:900}.piece.black{color:#000}
.sq.sel{outline:3px solid var(--sel);outline-offset:-3px}
.sq.hint::after{content:"";width:22%;height:22%;border-radius:50%;background:var(--hint);opacity:.85;display:block}
.sq.cap{box-shadow:inset 0 0 0 4px var(--warn)}
.side{min-width:260px;max-width:360px;display:flex;flex-direction:column;gap:10px}
.panel{background:#1b1b1b;border:1px solid #2b2b2b;border-radius:10px;padding:10px 12px}
.row{display:flex;justify-content:space-between;align-items:center;gap:10px}
.btn{padding:10px 12px;border-radius:8px;border:0;color:#111;background:var(--accent);font-weight:700;cursor:pointer}
.tiny{font-size:12px;opacity:.8}
.moves{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;line-height:1.45;max-height:260px;overflow:auto}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10}
.modal.show{display:flex}
.card{background:#1e1e1e;border:1px solid #2d2d2d;padding:16px;border-radius:12px;min-width:260px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
.pick{font-size:34px;padding:10px;border-radius:10px;border:1px solid #333;background:#121212;color:#fff;cursor:pointer}
#fx{position:fixed;inset:0;pointer-events:none;z-index:9}
.players{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-bottom:8px}
.player{display:flex;flex-direction:column;gap:6px;padding:8px;border-radius:8px;background:#101010;border:1px solid #222;min-width:120px;text-align:center}
.player .label{font-weight:800;font-size:13px}
.player .id{font-size:12px;opacity:.85;word-break:break-all}
.player .clock{font-weight:900;font-size:18px;padding:6px 8px;border-radius:8px;background:#0f0f0f;border:1px solid #222}
.player.active{box-shadow:0 0 0 3px rgba(244,180,0,0.06);border-color:#2b2b2b}
.clock.red{color:var(--warn)}
.rematch-count{font-size:18px;margin-top:8px;opacity:.9}
.rematch-actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
.btn-accept{background:#3bbf7f;color:#041;padding:8px 12px;border-radius:8px;font-weight:800;border:0;cursor:pointer}
.btn-decline{background:#bf3b3b;color:#210;padding:8px 12px;border-radius:8px;font-weight:800;border:0;cursor:pointer}
</style>
</head>
<body>
<h1>♞ CHESS ARENA for PI</h1>
<div class="sub">FIDE-legal: castling • en passant • promotion • check/checkmate • auto-queen promotion</div>
<div class="wrap">
<div id="board" aria-label="chessboard"></div>
<div class="side">
<div class="panel">
<div class="players">
<div id="playerWhite" class="player">
<div class="label">Player 1 (White)</div>
<div id="player1Id" class="id">(player1 id placeholder)</div>
<div id="clockW" class="clock">0:45</div>
</div>
<div id="playerBlack" class="player">
<div class="label">Player 2 (Black)</div>
<div id="player2Id" class="id">(player2 id placeholder)</div>
<div id="clockB" class="clock">0:45</div>
</div>
</div>
<div class="row" style="margin-top:8px">
<div id="status" style="font-weight:700">White to move</div>
<div id="incheck" style="display:none;padding:4px 8px;border-radius:8px;background:#2b2b2b">Check!</div>
</div>
<div class="row tiny"><div>Castling: <span id="cr">KQkq</span></div><div>En Passant: <span id="ep">—</span></div></div>
</div>
<div class="panel">
<div class="row"><div><b>Move List</b></div></div>
<div id="moves" class="moves"></div>
</div>
<div class="panel row">
<button class="btn" id="resignBtn">Resign</button>
<button class="btn" id="flipBtn">Flip</button>
<div class="tiny">Click a piece → click a target square</div>
</div>
</div>
</div>

<div id="promo" class="modal" role="dialog" aria-modal="true">
<div class="card">
<div style="font-weight:700;margin-bottom:6px">Promote pawn to:</div>
<div class="grid4">
<button class="pick" data-piece="q">♛</button>
<button class="pick" data-piece="r">♜</button>
<button class="pick" data-piece="b">♝</button>
<button class="pick" data-piece="n">♞</button>
</div>
</div>
</div>

<div id="rematchModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
<div class="card">
<div style="font-weight:800">Rematch?</div>
<div class="tiny" style="margin-top:8px">Accept to request rematch via Pi lobby/payment pairing.</div>
<div class="rematch-count" id="rematchCountdown">Auto-cancel in 5s</div>
<div class="rematch-actions">
<button id="rematchAccept" class="btn-accept">Accept</button>
<button id="rematchDecline" class="btn-decline">Decline</button>
</div>
</div>
</div>

<canvas id="fx"></canvas>

<script>
/* ------------- Config & Sounds ------------- */
const AUTO_PROMOTE = true, START_CLOCK=45, REMATCH_AUTO_CANCEL=5;
const SND = (()=>{let ctx; function beep(f=600,d=0.08,t='square',v=0.05){try{ctx=ctx||new (window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator(),g=ctx.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(ctx.destination);o.start();setTimeout(()=>o.stop(),d*1000);}catch(e){}} return {move:()=>beep(640,0.07,'square',0.05),capture:()=>{beep(220,0.05,'sawtooth',0.06);setTimeout(()=>beep(180,0.09,'sawtooth',0.05),60);},check:()=>beep(900
