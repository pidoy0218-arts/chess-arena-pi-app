<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chess Arena for Pi</title>
<style>
  :root{
    /* palette */
    --bg:#0e0d0a;
    --panel:#171410;
    --text:#f4efe8;
    --muted:#b8aa96;
    --accent:#d4a34a;
    --accent-2:#7b4a14;

    /* board classic wood */
    --light:#e9c99b;  /* one shade darker than earlier */
    --dark:#7a4b2b;
    /* pieces */
    --ebony:#111;      /* black */
    --ivory:#fffaf1;   /* white (solid ivory) */

    --shadow:0 12px 32px rgba(0,0,0,.35);
    --br:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 1200px at 50% -200px,#241c14 0%, #0e0d0a 60%);}
  body{font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; color:var(--text); display:flex; flex-direction:column; align-items:center; overflow-x:hidden}
  a,button{font-family:inherit}

  /* vertical stack container */
  .stack{width:100%; max-width:1024px; display:flex; flex-direction:column; align-items:center; gap:16px; padding:18px 12px 80px}

  /* INTRO (animated logo + title) */
  .intro{width:100%; display:flex; flex-direction:column; align-items:center; gap:10px; padding:22px 10px 6px}
  .emblem{
    width:92px;height:92px;border-radius:20px;background:linear-gradient(145deg,#2a1e14,#0f0b07);
    display:grid;place-items:center; box-shadow: var(--shadow), inset 0 0 0 2px #50341e;
    animation:introFloat 2.4s ease-in-out infinite;
  }
  @keyframes introFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
  .emblem svg{width:64px;height:64px;filter:drop-shadow(0 6px 12px rgba(0,0,0,.6))}
  .title{font-weight:900;font-size:1.6rem;letter-spacing:.3px; text-align:center}
  .subtitle{color:var(--muted); font-size:.95rem; margin-top:-2px}

  /* FRAME (card) */
  .frame{width:100%; background:linear-gradient(180deg,#1a140e 0%, #13100c 100%); border:1px solid #2c2117; border-radius:var(--br); box-shadow:var(--shadow)}
  .frameBody{padding:14px}

  /* Frame 1: login */
  .loginRow{display:flex; align-items:center; justify-content:center; gap:12px; padding:8px}
  .btn{background:var(--accent); color:#2b1e11; border:0; font-weight:800; padding:10px 14px; border-radius:999px; cursor:pointer}
  .btn.secondary{background:#2b231b; color:#e9dcc9; border:1px solid #3c2d1e}
  .chip{background:#0a0a0a; color:#9df59d; border-radius:999px; padding:6px 10px; font-weight:700; border:1px solid #1c2a1c}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center}

  /* Frame 2: small logo + toggles */
  .toggle{padding:8px 12px; border-radius:999px; border:1px solid #3b2b1d; background:#1c1510; color:#e9dcc9; font-weight:800; cursor:pointer}
  .toggle.active{background:var(--accent); color:#2b1e11; border-color:#8a5a1c}
  .toggle.disabled{opacity:.35; cursor:not-allowed; position:relative}
  .toggle.disabled::after{content:"LDRBOARD"; position:absolute; inset:0; display:grid; place-items:center; color:#c9b596; font-weight:900; letter-spacing:.6px}

  /* MAIN GAME SECTION */
  .mainCard{padding:12px}
  .topBar,.bottomBar{display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:8px; margin:8px 0}
  .idBox{display:flex; align-items:center; gap:8px; font-weight:800}
  .timer{font-weight:900; font-size:1.1rem; padding:8px 12px; border-radius:10px; border:1px solid #3b2b1d; background:#1a1410; min-width:110px; text-align:center}
  .timer.red{color:#ff6b6b}
  .caps{display:flex; gap:6px; flex-wrap:wrap; min-height:30px}
  .cap{width:22px;height:22px; border-radius:4px; display:grid; place-items:center; background:#0b0b0b; border:1px solid #3b2b1d; font-size:16px}

  .boardWrap{display:grid; place-items:center; padding:8px}
  .board{
    width:min(92vw, 640px); aspect-ratio:1;
    display:grid; grid-template-columns: repeat(8,1fr); grid-template-rows: repeat(8,1fr);
    border:6px solid #5f3a1e; border-radius:10px; overflow:hidden;
    background:linear-gradient(145deg,#d7b07c,#b9824d);
    box-shadow: 0 18px 40px rgba(0,0,0,.45), inset 0 0 0 2px #2f1b0c;
  }
  .sq{position:relative; display:flex; align-items:center; justify-content:center; user-select:none}
  .light{background:var(--light)}
  .dark{background:var(--dark)}
  .sq.highlight::after{content:""; position:absolute; inset:4px; border:3px solid #ffe166; border-radius:6px; pointer-events:none}
  .dot{position:absolute; width:16px;height:16px; border-radius:50%; background:rgba(255,235,59,.95); box-shadow:0 0 0 3px rgba(0,0,0,.2)}

  /* SVG pieces (ebony/ivory) using Unicode glyphs but forced solid color */
  .piece{font-size: min(8vw, 64px); line-height:1; filter: drop-shadow(0 4px 6px rgba(0,0,0,.55))}
  .w{color:var(--ivory); text-shadow:0 0 0 var(--ivory)}
  .b{color:var(--ebony); text-shadow:0 0 0 var(--ebony)}

  .history{max-height:160px; overflow:auto; border:1px solid #332417; background:#15110d; border-radius:10px; padding:8px}
  .move{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.9rem; padding:3px 6px; border-bottom:1px dashed #2b2016}

  /* confetti */
  #confetti{position:fixed; inset:0; pointer-events:none; z-index:9999}

  /* helper */
  .center{text-align:center}
</style>
</head>
<body>

<canvas id="confetti"></canvas>

<div class="stack">

  <!-- INTRO -->
  <section class="intro">
    <div class="emblem" id="introEmblem" aria-label="Animated Logo">
      <!-- knight silhouette -->
      <svg viewBox="0 0 64 64" aria-hidden="true">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop stop-color="#e5c083"/><stop offset="1" stop-color="#8b5a2e"/>
          </linearGradient>
        </defs>
        <circle cx="32" cy="32" r="28" fill="url(#g)" stroke="#5a3b1a" stroke-width="2"/>
        <path d="M42 40c-1 4-6 7-10 7s-9-3-10-7c0-5 5-7 7-10-3-1-7-3-7-7 0-6 6-9 12-9 5 0 10 2 12 6-6 0-8 1-10 4 4 1 8 4 8 9 0 3-1 5-2 7z" fill="#1a120c"/>
      </svg>
    </div>
    <div class="title">CHESS ARENA <span style="color:var(--accent)">for</span> PI</div>
    <div class="subtitle center">Animated intro • subtle sound • marketable top-center branding</div>
  </section>

  <!-- FRAME 1: Logo/Title + Login -->
  <section class="frame" id="frame1">
    <div class="frameBody center">
      <div class="row" style="justify-content:center;margin-bottom:8px">
        <span class="chip" id="piState">Pi Sandbox: Ready</span>
      </div>
      <div class="loginRow">
        <button class="btn" id="btnLogin">Sign In</button>
        <span id="loginWho" style="font-weight:800;color:var(--muted)">Not signed in</span>
      </div>
    </div>
  </section>

  <!-- FRAME 2: Small logo + Toggles (Puzzle / Classic / Quick / Leaderboard fog) -->
  <section class="frame" id="frame2">
    <div class="frameBody center">
      <div class="row" style="margin-bottom:10px;justify-content:center">
        <div class="emblem" style="width:52px;height:52px;border-radius:12px;animation:none">
          <svg viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="#8b5a2e"/></svg>
        </div>
      </div>
      <div class="row" style="justify-content:center">
        <button class="toggle" id="tgPuzzle">PUZZLE</button>
        <button class="toggle active" id="tgClassic">CLASSIC</button>
        <button class="toggle" id="tgQuick">QUICK</button>
        <button class="toggle disabled" id="tgLeader" disabled></button>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn secondary" id="startClassic">Start Classic 15|15</button>
        <button class="btn secondary" id="startQuick">Start Quick 0|30</button>
        <button class="btn" id="btnRematch">Rematch</button>
        <button class="btn" id="btnResign">Resign</button>
        <button class="btn" id="btnDraw">Offer Draw</button>
      </div>
    </div>
  </section>

  <!-- MAIN GAME FRAME -->
  <section class="frame mainCard" id="gameFrame">
    <!-- top display: opponent id + timer + captures -->
    <div class="topBar">
      <div class="idBox"><span>Opponent:</span><span id="oppName">Guest-B</span></div>
      <div class="timer" id="oppTimer">15:00</div>
      <div class="caps" id="oppCaps"></div>
    </div>

    <div class="boardWrap">
      <div class="board" id="board"></div>
    </div>

    <!-- below: player id + timer + captures + history -->
    <div class="bottomBar">
      <div class="idBox"><span>You:</span><span id="youName">Guest-W</span></div>
      <div class="timer" id="youTimer">15:00</div>
      <div class="caps" id="youCaps"></div>
    </div>
    <div class="frameBody">
      <div style="font-weight:800;margin:6px 0 6px 2px;">Move History</div>
      <div class="history" id="history"></div>
    </div>
  </section>

</div>

<!-- chess rules engine -->
<script src="https://unpkg.com/chess.js@1.0.0/dist/chess.min.js"></script>
<script>
/* ======== SOUND (WebAudio) ======== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq=600, ms=100, gain=0.03){
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "sine"; o.frequency.value = freq;
  g.gain.value = gain; o.connect(g); g.connect(audioCtx.destination);
  o.start(); setTimeout(()=>{o.stop();}, ms);
}
function trumpet(win=true){
  // simple triad sweep: win higher, lose lower
  const seq = win ? [880,988,1046] : [392,330,262];
  let t = 0;
  seq.forEach(f=>{
    setTimeout(()=>beep(f,150,0.04), t); t+=140;
  });
}

/* ======== CONFETTI ======== */
const confetti = (() => {
  const c = document.getElementById("confetti");
  const ctx = c.getContext("2d");
  function run(ms=1200){
    const W = innerWidth, H = innerHeight; c.width=W; c.height=H;
    const N=120, drops = Array.from({length:N},()=>({
      x: Math.random()*W, y: -20, vy: 2+Math.random()*4, w:4+Math.random()*6, h:4+Math.random()*8,
      hue: Math.floor(Math.random()*360)
    }));
    let t=0;
    (function step(){
      ctx.clearRect(0,0,W,H);
      drops.forEach(d=>{
        d.y+=d.vy;
        ctx.fillStyle = `hsl(${d.hue} 90% 60%)`;
        ctx.fillRect(d.x,d.y,d.w,d.h);
      });
      if((t+=16)<ms) requestAnimationFrame(step); else ctx.clearRect(0,0,W,H);
    })();
  }
  return { run };
})();

/* ======== STATE ======== */
const boardEl = document.getElementById("board");
const histEl = document.getElementById("history");
const youTimerEl = document.getElementById("youTimer");
const oppTimerEl = document.getElementById("oppTimer");
const youCapsEl = document.getElementById("youCaps");
const oppCapsEl = document.getElementById("oppCaps");
const btnLogin = document.getElementById("btnLogin");
const loginWho = document.getElementById("loginWho");

let game = new Chess();
let selected = null;
let legalTargets = new Set();
let mode = "classic"; // 'classic' | 'quick'
let youTime = 15*60;  // seconds
let oppTime = 15*60;
let perMove = 30;     // quick mode per-move
let turnClock = null;
let quickTicker = 0;

/* ======== UI HELPERS ======== */
function fmt(s){ const m = Math.floor(s/60), x = s%60; return `${m}:${x<10?"0":""}${x}`; }
function setTimers(){
  youTimerEl.textContent = fmt(youTime);
  oppTimerEl.textContent = fmt(oppTime);
}

function drawBoard(){
  boardEl.innerHTML = "";
  const b = game.board();
  for(let r=0; r<8; r++){
    for(let c=0; c<8; c++){
      const sq = document.createElement("div");
      sq.className = "sq " + ((r+c)%2===0 ? "light" : "dark");
      sq.dataset.r = r; sq.dataset.c = c;
      const p = b[r][c];
      if(p){
        const span = document.createElement("span");
        span.className = "piece " + (p.color==="w"?"w":"b");
        // Unicode glyphs; colored to solid ivory/ebony by CSS
        span.textContent = pieceGlyph(p.type, p.color);
        sq.appendChild(span);
      }
      sq.addEventListener("click", ()=> onSquare(r,c));
      boardEl.appendChild(sq);
    }
  }
  // highlights
  if(selected){
    const key = rcToAlg(selected.r, selected.c);
    const moves = game.moves({square:key, verbose:true});
    for(const m of moves){
      const {r,c} = algToRC(m.to);
      const cell = cellAt(r,c);
      const dot = document.createElement("div");
      dot.className = "dot"; cell.appendChild(dot);
      cell.classList.add("highlight");
    }
  }
}

function cellAt(r,c){ return boardEl.children[r*8+c]; }
function rcToAlg(r,c){ return "abcdefgh"[c] + (8-r); }
function algToRC(al){ return {c:al.charCodeAt(0)-97, r:8-parseInt(al[1])}; }

function pieceGlyph(t,color){
  const map = {
    k:{w:"♔",b:"♚"}, q:{w:"♕",b:"♛"}, r:{w:"♖",b:"♜"},
    b:{w:"♗",b:"♝"}, n:{w:"♘",b:"♞"}, p:{w:"♙",b:"♟"}
  };
  return map[t][color];
}

function pushHistory(str){
  const div = document.createElement("div");
  div.className = "move";
  div.textContent = str;
  histEl.prepend(div);
}

/* ======== GAMEPLAY ======== */
function onSquare(r,c){
  const board = game.board();
  const p = board[r][c];
  if(!selected){
    if(p && p.color === currentSide()){ // select your side only (you = white)
      selected = {r,c};
      drawBoard();
    }
    return;
  }
  const move = { from: rcToAlg(selected.r,selected.c), to: rcToAlg(r,c) };

  // promotion auto to queen for now (can open prompt later)
  const legal = game.moves({square: move.from, verbose:true}).map(m=>m.to);
  if(legal.includes(move.to)){
    // promotion check
    const piece = game.get(move.from);
    if(piece && piece.type==='p' && (move.to.endsWith('8') || move.to.endsWith('1'))){
      move.promotion = 'q';
    }
  }

  const result = game.move(move);
  if(result){
    beep(740,70,0.03);
    handlePostMove(result);
  }else{
    // reselect if clicking own piece
    selected = (p && p.color===currentSide()) ? {r,c} : null;
    drawBoard();
  }
}

function currentSide(){ return game.turn(); } // 'w' | 'b'

function handlePostMove(m){
  // captures panel
  if(m.captured){
    const span = document.createElement("div");
    span.className = "cap";
    span.textContent = pieceGlyph(m.captured, m.color==='w'?'b':'w');
    if(m.color==='w') oppCapsEl.appendChild(span); else youCapsEl.appendChild(span);
  }

  // notation
  pushHistory(m.san);

  selected = null;
  drawBoard();

  // end checks
  if(game.in_checkmate()){
    stopTimers();
    if(game.turn()==='w'){ // black delivered mate, white to move but checkmated
      trumpet(false);
      alert("Checkmate — Black wins");
    }else{
      trumpet(true);
      confetti.run();
      alert("Checkmate — White wins");
    }
    return;
  }
  if(game.in_stalemate()){
    stopTimers();
    alert("Stalemate — Draw");
    return;
  }
  if(game.in_draw()){
    stopTimers();
    alert("Draw");
    return;
  }

  // switch timers
  switchTimersAfterMove();
}

/* ======== TIMERS ======== */
function clearTicker(){
  if(turnClock){ clearInterval(turnClock); turnClock=null; }
}
function stopTimers(){ clearTicker(); }
function startClassicTimers(){
  mode="classic";
  youTime=15*60; oppTime=15*60;
  setTimers();
  youTimerEl.classList.remove("red");
  oppTimerEl.classList.remove("red");
  clearTicker();
  // White starts
  turnClock = setInterval(()=>{
    youTime--; if(youTime<=0){ youTime=0; setTimers(); trumpet(false); stopTimers(); alert("White flag fall — Black wins"); return; }
    if(youTime<=10) youTimerEl.classList.add("red");
    setTimers();
  },1000);
}
function startQuickTimers(){
  mode="quick";
  youTime=0; oppTime=0; // not used for display; we show per-move 30s in center bars
  setTimers();
  youTimerEl.textContent="0:30"; oppTimerEl.textContent="0:30";
  youTimerEl.classList.remove("red"); oppTimerEl.classList.remove("red");
  clearTicker();
  quickTicker=30;
  turnClock=setInterval(()=>{
    quickTicker--;
    youTimerEl.textContent = (game.turn()==='w') ? fmt(quickTicker) : "0:30";
    oppTimerEl.textContent = (game.turn()==='b') ? fmt(quickTicker) : "0:30";
    if(quickTicker<=10){
      if(game.turn()==='w') youTimerEl.classList.add("red"); else oppTimerEl.classList.add("red");
    }
    if(quickTicker<=0){
      trumpet(false);
      stopTimers();
      alert((game.turn()==='w'?"White":"Black") + " ran out of time");
    }
  },1000);
}
function switchTimersAfterMove(){
  if(mode==="classic"){
    // pause current interval and start opponent’s
    clearTicker();
    if(game.turn()==='w'){ // black just moved; now white to move -> run white
      oppTimerEl.classList.remove("red");
      turnClock=setInterval(()=>{
        youTime--; if(youTime<=0){ youTime=0; setTimers(); trumpet(false); stopTimers(); alert("White flag fall — Black wins"); return; }
        if(youTime<=10) youTimerEl.classList.add("red");
        setTimers();
      },1000);
    }else{
      youTimerEl.classList.remove("red");
      turnClock=setInterval(()=>{
        oppTime--; if(oppTime<=0){ oppTime=0; setTimers(); trumpet(true); stopTimers(); alert("Black flag fall — White wins"); return; }
        if(oppTime<=10) oppTimerEl.classList.add("red");
        setTimers();
      },1000);
    }
  }else{
    // quick: reset to 30s for the side to move
    quickTicker=30;
    youTimerEl.classList.remove("red"); oppTimerEl.classList.remove("red");
    youTimerEl.textContent = (game.turn()==='w') ? "0:30" : "0:30";
    oppTimerEl.textContent = (game.turn()==='b') ? "0:30" : "0:30";
  }
}

/* ======== CONTROLS ======== */
document.getElementById("startClassic").addEventListener("click", ()=>{
  mode="classic";
  game = new Chess(); selected=null; histEl.innerHTML=""; youCapsEl.innerHTML=""; oppCapsEl.innerHTML="";
  drawBoard();
  startClassicTimers();
});

document.getElementById("startQuick").addEventListener("click", ()=>{
  mode="quick";
  game = new Chess(); selected=null; histEl.innerHTML=""; youCapsEl.innerHTML=""; oppCapsEl.innerHTML="";
  drawBoard();
  startQuickTimers();
});

document.getElementById("btnRematch").addEventListener("click", ()=>{
  beep(620,80,0.03);
  if(mode==="classic") document.getElementById("startClassic").click();
  else document.getElementById("startQuick").click();
});

document.getElementById("btnResign").addEventListener("click", ()=>{
  trumpet(false); stopTimers();
  alert("You resigned.");
});
document.getElementById("btnDraw").addEventListener("click", ()=>{
  beep(500,90,0.03);
  alert("Draw offer sent (UI only).");
});

/* toggles (visual only) */
const tgClassic = document.getElementById("tgClassic");
const tgQuick = document.getElementById("tgQuick");
const tgPuzzle = document.getElementById("tgPuzzle");

[tgClassic,tgQuick,tgPuzzle].forEach(b=>{
  b.addEventListener("click",()=>{
    [tgClassic,tgQuick,tgPuzzle].forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
  });
});

/* Login mock */
btnLogin.addEventListener("click", ()=>{
  loginWho.textContent = "Signed in as PiPlayer";
  beep(800,120,0.03);
});

/* INIT */
function buildSquares(){
  boardEl.innerHTML = "";
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const d=document.createElement("div");
      d.className="sq "+(((r+c)%2===0)?"light":"dark");
      d.dataset.r=r; d.dataset.c=c;
      d.addEventListener("click",()=>onSquare(r,c));
      boardEl.appendChild(d);
    }
  }
}
function initialRender(){
  buildSquares();
  drawBoard();
  setTimers();
  // intro sound
  setTimeout(()=>beep(660,120,0.03),220);
  setTimeout(()=>beep(880,160,0.03),420);
}
initialRender();
</script>
</body>
</html>
