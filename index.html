<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chess Arena — Playable Core</title>

<!-- chessboard.js CSS (CDN) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/css/chessboard.min.css" integrity="sha512-0kZy5dO1uGd3s5zKq+8qv5p4z0rY1mNv2m+6f6g2pkQj6Z/7yQvX/1YvEwG8g9Zp0QdQfQYgk0Yz0xZl0p6G3Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
  :root{
    --bg:#efe9df;
    --wood-light:#f0d9b5;
    --wood-dark:#8b4a2a;
    --panel:#fff;
    --accent:#d09a2b;
    --muted:#5b4638;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:var(--muted)}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
  .card{width:100%;max-width:980px;background:linear-gradient(180deg,#f7f2ea,#efe1c9);border-radius:12px;padding:16px;box-shadow:0 18px 60px rgba(0,0,0,.12);border:1px solid rgba(0,0,0,.04)}
  .head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:#3b2210;display:grid;place-items:center;color:#fff;font-weight:900;font-size:28px}
  .title{font-weight:800;font-size:18px;color:#3a2a1f}
  .hdrRight{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);border:0;padding:8px 12px;border-radius:999px;color:#120f0b;font-weight:800;cursor:pointer}
  .layout{display:flex;gap:12px;align-items:flex-start}
  /* chessboard container */
  #boardWrapper{background:linear-gradient(180deg,#b07a45,#7d4c26);padding:12px;border-radius:10px;box-shadow:inset 0 4px 0 rgba(255,255,255,.04),0 14px 40px rgba(0,0,0,.18)}
  #board { width: 640px; max-width: 72vw; }
  /* side panels */
  .side{width:300px;display:flex;flex-direction:column;gap:12px}
  .panel{background:var(--panel);padding:12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.04)}
  .panel h4{margin:0 0 8px 0;font-size:13px;color:var(--muted)}
  .moves{max-height:300px;overflow:auto;font-family:monospace;padding:6px;background:transparent;border-radius:6px}
  .moveItem{padding:6px 8px;border-radius:6px;margin-bottom:6px;background:rgba(0,0,0,.02)}
  .captured{display:flex;gap:6px;flex-wrap:wrap}
  .capPiece{font-size:20px}
  #status{margin-top:8px;font-weight:700;color:#3a2a1f}
  /* promotion modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.55));z-index:9999}
  .promo{background:var(--panel);padding:14px;border-radius:10px;box-shadow:0 20px 60px rgba(0,0,0,.6);min-width:260px;text-align:center}
  .promoBtns{display:flex;gap:10px;justify-content:center;margin-top:10px}
  .promoBtn{padding:10px 12px;border-radius:8px;border:0;background:#fff;cursor:pointer;font-weight:800}
  .promoBtn.black{background:#222;color:#fff}
  /* responsive */
  @media(max-width:980px){
    .layout{flex-direction:column;align-items:center}
    .side{width:100%}
    #board{width:92vw}
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="card" role="application" aria-label="Chess Arena playable core">
    <div class="head">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="logo" aria-hidden="true">♞</div>
        <div>
          <div class="title">THE CHESS ARENA</div>
          <div style="font-size:12px;color:#6b5444;margin-top:4px">for Pi — playable core</div>
        </div>
      </div>
      <div class="hdrRight">
        <button class="btn" id="restartBtn">Restart</button>
        <button class="btn" id="exportFen">Export FEN</button>
      </div>
    </div>

    <div class="layout">
      <div id="boardWrapper">
        <div id="board"></div>
        <div id="status">Loading...</div>
      </div>

      <div class="side" aria-hidden="false">
        <div class="panel">
          <h4>Move History</h4>
          <div id="moves" class="moves" aria-live="polite"></div>
        </div>

        <div class="panel">
          <h4>Captured</h4>
          <div style="margin-top:6px"><strong>White captured:</strong><div id="capWhite" class="captured"></div></div>
          <div style="margin-top:8px"><strong>Black captured:</strong><div id="capBlack" class="captured"></div></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- promotion modal -->
<div id="promoModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="promo" role="document">
    <div style="font-weight:800">Promote pawn — choose piece</div>
    <div class="promoBtns" id="promoChoices"></div>
    <div style="text-align:center;margin-top:10px"><button id="promoCancel" style="padding:8px 12px;border-radius:8px;border:0;cursor:pointer">Cancel</button></div>
  </div>
</div>

<!-- libs: jQuery (chessboard.js depends on it), chessboard.js, chess.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-3gJwYp8mX+K2YV6Gm8Yp0W+9u4/H7Qb0b6+3T4zU0b9Iu0p2m1f3fW/2rQKjVsKxJ5dGvRk2dQq0m6wXq4XQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/js/chessboard.min.js" integrity="sha512-W8P1h9oi3H8q7Xr4qVh3z7p2G3Xwq0g2F1x1p1F2QX2pM1mQp1zP+2YgQj7g3nI9yK1p1s1D2x1Q3m4t5y6z==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js" integrity="sha512-2X0kCjG1k4x6f8wY1g3mP5n7rQ8yT0kL3mN1vQ2p3n5w6R7s8t9u0v1w2x3y4z5a6b7c8d9e0f1g2h3i4j5k6l==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
  // ---------------------------
  // Setup: chess.js + chessboard.js
  // ---------------------------
  const game = new Chess(); // chess.js - rules & state
  let board = null;         // chessboard.js instance
  let promotionPending = null; // {from, to, color}

  // unicode pieces for captured list display:
  const glyphs = { p:'♟', r:'♜', n:'♞', b:'♝', q:'♛', k:'♚', P:'♙', R:'♖', N:'♘', B:'♗', Q:'♕', K:'♔' };

  // initialize chessboard.js
  function onDragStart (source, piece, position, orientation) {
    // do not pick up pieces if the game is over
    if (game.game_over()) return false;
    // only pick up pieces for the side to move
    if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
        (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
      return false;
    }
  }

  function onDrop (source, target, piece, newPos, oldPos, orientation) {
    // detect simple promotion possibility (pawn to last rank)
    const movingPiece = piece; // e.g., 'wP' or 'bP'
    const isPawn = movingPiece[1].toLowerCase() === 'p';
    const targetRank = parseInt(target[1], 10); // 1..8
    if (isPawn && (targetRank === 1 || targetRank === 8)) {
      // cancel visual drop, prompt for promotion choice
      board.position(oldPos);
      promotionPending = { from: source, to: target, color: movingPiece[0] === 'w' ? 'w' : 'b' };
      showPromotionModal(promotionPending.color);
      return;
    }

    const move = game.move({ from: source, to: target, promotion: 'q' });
    if (move === null) {
      return 'snapback';
    } else {
      updateUI();
    }
  }

  function onSnapEnd () {
    board.position(game.fen());
  }

  const cfg = {
    draggable: true,
    position: 'start',
    pieceTheme: function(piece) {
      // simple wooden-themed external pieces can be used here, but we use built-in images.
      // You can replace URLs with your own SVG/PNG set (match chessboard.js naming).
      return 'https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/img/chesspieces/wikipedia/' + piece + '.png';
    },
    onDragStart: onDragStart,
    onDrop: onDrop,
    onSnapEnd: onSnapEnd
  };

  $(function(){
    board = Chessboard('board', cfg);
    updateUI();
  });

  // ---------------------------
  // Promotion modal logic
  // ---------------------------
  const promoModal = document.getElementById('promoModal');
  const promoChoices = document.getElementById('promoChoices');
  const promoCancel = document.getElementById('promoCancel');

  function showPromotionModal(color){
    promoChoices.innerHTML = '';
    const pieces = ['q','r','b','n'];
    pieces.forEach(p=>{
      const btn = document.createElement('button');
      btn.className = 'promoBtn' + (color === 'b' ? ' black' : '');
      btn.innerText = (color === 'w') ? glyphs[p.toUpperCase()] : glyphs[p];
      btn.addEventListener('click', ()=>{
        promoModal.style.display='none';
        promoModal.setAttribute('aria-hidden','true');
        if(promotionPending){
          const mv = game.move({ from: promotionPending.from, to: promotionPending.to, promotion: p });
          promotionPending = null;
          if(mv) updateUI();
          board.position(game.fen());
        }
      });
      promoChoices.appendChild(btn);
    });
    promoCancel.onclick = ()=>{
      promoModal.style.display='none';
      promoModal.setAttribute('aria-hidden','true');
      promotionPending = null;
    };
    promoModal.style.display = 'flex';
    promoModal.setAttribute('aria-hidden','false');
  }

  // ---------------------------
  // UI updates: history, captured, status
  // ---------------------------
  function updateUI(){
    board.position(game.fen()); // sync board
    updateStatus();
    updateMoves();
    updateCaptured();
  }

  function updateStatus(){
    const statusEl = document.getElementById('status');
    if (game.in_checkmate()) {
      statusEl.innerText = 'Checkmate — ' + (game.turn() === 'w' ? 'Black' : 'White') + ' wins';
    } else if (game.in_stalemate()) {
      statusEl.innerText = 'Stalemate — Draw';
    } else if (game.in_threefold_repetition() || game.insufficient_material()) {
      statusEl.innerText = 'Draw';
    } else {
      statusEl.innerText = (game.turn() === 'w' ? 'White' : 'Black') + ' to move' + (game.in_check() ? ' — CHECK!' : '');
    }
  }

  function updateMoves(){
    const movesEl = document.getElementById('moves');
    const history = game.history({verbose:true});
    movesEl.innerHTML = '';
    for (let i = 0; i < history.length; i += 2){
      const moveNumber = Math.floor(i/2) + 1;
      const white = history[i] ? history[i].san : '';
      const black = history[i+1] ? history[i+1].san : '';
      const row = document.createElement('div');
      row.className = 'moveItem';
      row.textContent = `${moveNumber}. ${white} ${black}`;
      movesEl.appendChild(row);
    }
    movesEl.scrollTop = movesEl.scrollHeight;
  }

  function updateCaptured(){
    const capWhite = document.getElementById('capWhite');
    const capBlack = document.getElementById('capBlack');
    capWhite.innerHTML = '';
    capBlack.innerHTML = '';
    // derive captured pieces by comparing starting counts and current board
    const startCounts = { p:8, r:2, n:2, b:2, q:1 };
    const counts = { w: { p:0,r:0,n:0,b:0,q:0 }, b: { p:0,r:0,n:0,b:0,q:0 } };
    const b = game.board();
    for (let r=0;r<8;r++){
      for (let c=0;c<8;c++){
        const p = b[r][c];
        if(p){
          if(p.type !== 'k') counts[p.color][p.type] = (counts[p.color][p.type]||0) + 1;
        }
      }
    }
    ['q','r','b','n','p'].forEach(t=>{
      const wcap = (startCounts[t]||0) - (counts['w'][t]||0);
      const bcap = (startCounts[t]||0) - (counts['b'][t]||0);
      for(let i=0;i<wcap;i++){ const s=document.createElement('div'); s.className='capPiece'; s.textContent = glyphs[t.toUpperCase()]; capWhite.appendChild(s); }
      for(let i=0;i<bcap;i++){ const s=document.createElement('div'); s.className='capPiece'; s.textContent = glyphs[t]; capBlack.appendChild(s); }
    });
  }

  // ---------------------------
  // Buttons
  // ---------------------------
  document.getElementById('restartBtn').addEventListener('click', ()=>{
    game.reset();
    board.position('start');
    updateUI();
  });
  document.getElementById('exportFen').addEventListener('click', ()=>{
    navigator.clipboard?.writeText(game.fen());
    alert('FEN copied to clipboard:\n' + game.fen());
  });

  // initial UI sync
  updateUI();
</script>
</body>
</html>
