<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chess Arena for Pi</title>

<!-- Pi SDK (sandbox/testnet) -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<!-- Socket.IO client (for realtime multiplayer) -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
  :root{
    --bg:#0f0f12;
    --panel:#1a1d22;
    --accent:#ffb700;
    --wood-light:#f0d9b5;
    --wood-dark:#b58863;
    --ivory:#f8f8f0;
    --ebony:#2c2c2c;
    --white:#fff;
    --muted:#9aa0a6;
    --good:#37d67a;
    --warn:#ff4d4f;
  }
  *{ box-sizing:border-box }
  body{
    margin:0; background:var(--bg); color:var(--white);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }

  /* Intro frame (animated knight pop-in + trumpet) */
  .frame{ display:none; min-height:100svh; padding:20px; }
  .frame.active{ display:flex; align-items:center; justify-content:center; }

  .intro{
    display:flex; flex-direction:column; align-items:center; gap:16px;
    text-align:center;
  }
  .knight{
    width:120px; height:120px; border-radius:20px;
    background: radial-gradient(60% 60% at 40% 35%, #fff 0%, #ddd 60%, #bbb 100%);
    position:relative; box-shadow:0 10px 40px rgba(0,0,0,.45);
    animation:pop .7s ease-out both;
  }
  .knight:before{
    content:""; position:absolute; inset:14% 18% 18% 18%;
    background: conic-gradient(from 210deg, #333 0 15%, #666 15% 40%, #999 40% 100%);
    border-radius:30% 30% 10% 10%/40% 40% 20% 20%;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,.4));
  }
  @keyframes pop{ 0%{ transform:scale(.7); opacity:0 } 100%{ transform:scale(1); opacity:1 } }

  .brand{
    display:flex; flex-direction:column; align-items:center; gap:6px;
  }
  .title{ font-weight:800; letter-spacing:.5px; font-size:28px }
  .subtitle{ font-size:12px; color:var(--muted) } /* small “for” */

  .powered{ margin-top:4px; font-size:14px; color:#fff; opacity:.95 } /* bright white, one size larger than subtle */

  .cta{
    display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; justify-content:center;
  }
  .btn{
    background:var(--accent); color:#1a1a1a; border:0; padding:12px 16px; font-weight:700;
    border-radius:999px; cursor:pointer; transition:transform .15s ease, opacity .15s;
  }
  .btn:hover{ transform: translateY(-1px); opacity:.95 }
  .btn.secondary{
    background:#2a2f36; color:#fff; border:1px solid #3a414b;
  }

  /* Sub-intro: logo + small rounded toggles */
  .sub{
    display:flex; flex-direction:column; align-items:center; gap:14px; text-align:center;
    background:var(--panel); padding:18px; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.35);
    width:min(520px, 92vw);
  }
  .toggle-row{
    display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
  }
  .toggle{
    user-select:none; font-size:14px; font-weight:700; padding:8px 12px; border-radius:999px;
    background:#22272e; border:1px solid #353c46; cursor:pointer; opacity:.9;
  }
  .toggle.active{ outline:2px solid var(--accent) }

  /* Board frame */
  .arena{
    display:grid; grid-template-columns: 1fr min(480px, 92vw) 1fr;
    align-items:start; gap:12px; width:100%; max-width:1200px; margin:0 auto;
  }
  .stack{ display:flex; flex-direction:column; gap:8px }

  .panel{
    background:var(--panel); border:1px solid #2b313a; border-radius:18px; padding:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.25);
  }
  .panel h3{ margin:0 0 8px 0; font-size:14px; color:var(--muted); font-weight:700; letter-spacing:.4px }

  /* Board */
  .board-wrap{ display:flex; flex-direction:column; align-items:center; gap:10px }
  canvas#board{ border:4px solid #5c4033; border-radius:12px; width:min(92vw, 520px); height:auto; max-height:92svh; }

  /* Timer (top of board, not protruding) */
  .timer{ font-weight:800; letter-spacing:.5px; padding:6px 10px; border-radius:10px; background:#22272e; display:inline-block }
  .timer.warn{ color:var(--warn) }

  /* Left: Controls (under the board, split with captured/history) */
  .controls{ display:grid; grid-template-columns: 1fr 1fr; gap:8px }
  .pill{ background:#22272e; border:1px solid #353c46; border-radius:999px; padding:8px 10px; font-size:14px; font-weight:700; text-align:center; cursor:pointer }
  .pill:disabled{ opacity:.55; cursor:not-allowed }

  /* Right: Captured + Move History */
  .captured, .history{ min-height:120px }
  .captured-row{ display:flex; flex-wrap:wrap; gap:4px }
  .cap{ width:18px; height:18px; border-radius:50% }
  .cap.white{ background:var(--ivory); border:1px solid #ddd }
  .cap.black{ background:var(--ebony) }

  .moves{ max-height:260px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; background:#1b1f26; border-radius:10px; padding:8px; border:1px solid #2a3039 }

  .status{ text-align:center; font-weight:800; margin-top:6px }

  footer{
    text-align:center; color:var(--muted); font-size:12px; padding:14px;
  }
</style>
</head>
<body>

<!-- FRAME 1: Intro (animated knight + login) -->
<section id="frame-intro" class="frame active">
  <div class="intro">
    <div class="knight" id="knight"></div>
    <div class="brand">
      <div class="title">CHESS ARENA <span class="subtitle">for</span> PI</div>
      <div class="powered">Powered by Pi</div>
    </div>
    <div class="cta">
      <button class="btn" id="btnPiLogin">Login with Pi</button>
      <button class="btn secondary" id="btnSkip">Continue (offline test)</button>
    </div>

    <!-- Sub-intro: small rounded toggles (not under the board) -->
    <div class="sub">
      <div class="toggle-row" id="topToggles">
        <div class="toggle active" data-mode="classic">Classic Chess</div>
        <div class="toggle" data-mode="quick">Quick Chess</div>
        <div class="toggle" data-mode="ai">Versus AI</div>
        <div class="toggle" data-mode="leaderboard">Leaderboard</div>
      </div>
      <div style="font-size:12px; color:var(--muted)">Choose a mode then Create/Join a match below</div>
      <div class="cta" style="margin-top:8px">
        <button class="btn" id="btnCreate">Create Match</button>
        <button class="btn secondary" id="btnJoin">Join Match</button>
      </div>
      <div id="matchInfo" style="font-size:13px; color:var(--muted)"></div>
    </div>
  </div>
</section>

<!-- FRAME 2: Arena (same view for both players) -->
<section id="frame-arena" class="frame">
  <div class="arena">
    <!-- LEFT: Controls under board (split area) -->
    <div class="stack">
      <div class="panel">
        <h3>Controls</h3>
        <div class="controls">
          <button class="pill" id="btnDraw">Offer Draw</button>
          <button class="pill" id="btnResign">Resign</button>
          <button class="pill" id="btnRematch" disabled>Rematch</button>
          <button class="pill" id="btnLeave">Leave</button>
        </div>
      </div>

      <div class="panel captured">
        <h3>Captured Pieces</h3>
        <div class="captured-row" id="capWhite"></div>
        <div class="captured-row" id="capBlack"></div>
      </div>
    </div>

    <!-- CENTER: Board -->
    <div class="stack" style="align-items:center;">
      <div class="timer" id="timer">⏳ 30s</div>
      <div class="board-wrap panel" style="padding:10px;">
        <canvas id="board" width="520" height="520"></canvas>
      </div>
      <div class="status" id="status"></div>
    </div>

    <!-- RIGHT: History + Info -->
    <div class="stack">
      <div class="panel history">
        <h3>Move History</h3>
        <div class="moves" id="moves"></div>
      </div>
      <div class="panel">
        <h3>Match</h3>
        <div id="whoami" style="font-size:13px; color:var(--muted)"></div>
        <div id="oppo" style="font-size:13px; color:var(--muted)"></div>
      </div>
    </div>
  </div>
</section>

<footer>© Chess Arena <span style="opacity:.85">for</span> Pi</footer>

<audio id="sfx-trumpet">
  <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3">
</audio>
<audio id="sfx-tick">
  <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3">
</audio>
<audio id="sfx-move">
  <source src="data:audio/mp3;base64,//uQZAAAAAAAA..." type="audio/mp3">
</audio>
<audio id="sfx-win">
  <source src="data:audio/mp3;base64,//uQZAAAA..." type="audio/mp3">
</audio>

<script>
/* ========= Pi SDK (Sandbox/Testnet) ========= */
const App = {
  me: null,              // {username, uid}
  token: null,           // accessToken
  lobbyMode: "classic",  // classic | quick | ai | leaderboard
  matchId: null,
  color: null,           // "white" | "black"
  socket: null,
  isMyTurn: true,
  over: false,
  timeLeft: 30,
  timerHandle: null,
  oppo: null
};

Pi.init({ version: "2.0", sandbox: true });

document.getElementById("btnPiLogin").onclick = async () => {
  try{
    const scopes = ["username","payments"];
    const auth = await Pi.authenticate(scopes, (p)=>console.log("incomplete payment:",p));
    App.me = auth.user;
    App.token = auth.accessToken;
    document.getElementById("matchInfo").textContent = `Signed in as @${App.me.username}`;
  }catch(e){
    console.warn("Pi login failed (still can test offline):", e);
  }
};

document.getElementById("btnSkip").onclick = () => {
  App.me = { username: "guest"+Math.floor(Math.random()*9999), uid: "guest" };
  document.getElementById("matchInfo").textContent = `Offline test as ${App.me.username}`;
};

/* ========= Top Mode Toggles ========= */
document.querySelectorAll(".toggle").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".toggle").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    App.lobbyMode = t.dataset.mode;
  }
});

/* ========= Matchmaking (Socket.IO) ========= */
/* Replace with your backend wss URL (same host as your backend container / reverse proxy). */
const BACKEND_WS = (location.protocol === "https:" ? "wss://" : "ws://") + (location.host.includes(":") ? location.host : location.host.replace(/:.*/,''));

function connectSocket(){
  if(App.socket) return;
  // If your reverse-proxy routes /socket to backend, this will reach it:
  App.socket = io(BACKEND_WS, { path: "/socket", transports:["websocket"] });

  App.socket.on("connect", ()=> console.log("socket connected", App.socket.id));
  App.socket.on("joined", (payload)=>{
    App.matchId = payload.matchId;
    App.color   = payload.color;  // white/black
    App.oppo    = payload.oppo || null;
    updateMatchInfo();
  });

  App.socket.on("opponent", (op)=>{ App.oppo = op; updateMatchInfo(); });

  App.socket.on("start", ()=> {
    showArena();
    startGame();
  });

  App.socket.on("move", onRemoteMove);
  App.socket.on("control", onRemoteControl);
}

function updateMatchInfo(){
  const who = document.getElementById("whoami");
  const op  = document.getElementById("oppo");
  who.textContent = `You: @${(App.me && App.me.username)||"guest"} • ${App.color||"—"}`;
  op.textContent  = `Opponent: ${(App.oppo && "@"+App.oppo.username) || "—"}`;
  const info = document.getElementById("matchInfo");
  if(App.matchId){
    info.innerHTML = `Match ID: <b>${App.matchId}</b> • Share this code. Waiting for opponent…`;
  }
}

document.getElementById("btnCreate").onclick = ()=>{
  if(!App.me){ alert("Login with Pi (or continue offline) first."); return; }
  connectSocket();
  App.socket.emit("create", {
    mode: App.lobbyMode,
    user: App.me
  });
};

document.getElementById("btnJoin").onclick = ()=>{
  if(!App.me){ alert("Login with Pi (or continue offline) first."); return; }
  const code = prompt("Enter Match ID");
  if(!code) return;
  connectSocket();
  App.socket.emit("join", {
    matchId: code.trim(),
    user: App.me
  });
};

/* ========= Arena + Board ========= */
const intro = document.getElementById("frame-intro");
const arena = document.getElementById("frame-arena");
const cvs   = document.getElementById("board");
const ctx   = cvs.getContext("2d");
const tile  = 65; // visually large but leaves space for controls
const N     = 8;

function showArena(){
  intro.classList.remove("active");
  arena.classList.add("active");
}

function drawBoard(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      ctx.fillStyle = ((r+c)%2===0) ? "#f0d9b5" : "#b58863";
      ctx.fillRect(c*tile, r*tile, tile, tile);
    }
  }
}

const startPos = [
  "rnbqkbnr",
  "pppppppp",
  "........",
  "........",
  "........",
  "........",
  "PPPPPPPP",
  "RNBQKBNR"
];

const PIECES = []; // {t:'P', c:'white', r, c}
function resetPieces(){
  PIECES.length=0;
  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      const ch = startPos[r][c];
      if(ch!=='.'){
        const isWhite = ch===ch.toUpperCase();
        PIECES.push({ t: ch.toUpperCase(), c: isWhite?'white':'black', r, c });
      }
    }
  }
}
function at(r,c){ return PIECES.find(p=>p.r===r&&p.c===c); }
function drawPieces(){
  for(const p of PIECES){
    ctx.fillStyle = p.c==='white' ? "#f8f8f0" : "#2c2c2c";
    // simple disc for clarity; crisp on mobile
    ctx.beginPath();
    ctx.arc(p.c*tile + tile/2, p.r*tile + tile/2, tile*0.34, 0, Math.PI*2);
    ctx.fill();
  }
}
function algebra(r,c){ return "abcdefgh"[c] + (8-r); }

let sel = null;
let turn = "white";
let moves = [];
let capW = [], capB = [];

function pushMove(p, r2, c2, captured=null){
  const from = algebra(p.r, p.c);
  const to   = algebra(r2, c2);
  moves.push(`${moves.length+1}. ${p.c[0].toUpperCase()}${from}-${to}${captured?'x':''}`);
  document.getElementById("moves").textContent = moves.join("\n");
}

function renderCaptured(){
  const w = document.getElementById("capWhite");
  const b = document.getElementById("capBlack");
  w.innerHTML = ""; b.innerHTML = "";
  capW.forEach(()=>{ const d=document.createElement("div"); d.className="cap white"; w.appendChild(d); });
  capB.forEach(()=>{ const d=document.createElement("div"); d.className="cap black"; b.appendChild(d); });
}

function legalLine(p, dr, dc){
  const res=[];
  let r=p.r+dr, c=p.c+dc;
  while(r>=0&&r<8&&c>=0&&c<8){
    const q=at(r,c);
    if(!q){ res.push([r,c]); }
    else{ if(q.c!==p.c) res.push([r,c]); break; }
    r+=dr; c+=dc;
  }
  return res;
}
function legalMoves(p){
  // minimalist legal moves (no check detection / castle / en-passant to keep code compact here)
  const M=[];
  if(p.t==='P'){
    const dir = p.c==='white' ? -1 : 1;
    const r1=p.r+dir, r2=p.r+2*dir;
    if(!at(r1,p.c) && r1>=0 && r1<8) M.push([r1,p.c]);
    const home = p.c==='white'?6:1;
    if(p.r===home && !at(r1,p.c) && !at(r2,p.c)) M.push([r2,p.c]);
    // captures
    [[dir,-1],[dir,1]].forEach(([dr,dc])=>{
      const r=p.r+dr, c=p.c+dc;
      const q = (r>=0&&r<8&&c>=0&&c<8) ? at(r,c) : null;
      if(q && q.c!==p.c) M.push([r,c]);
    });
  } else if(p.t==='R'){ M.push(...legalLine(p,1,0),...legalLine(p,-1,0),...legalLine(p,0,1),...legalLine(p,0,-1)); }
  else if(p.t==='B'){ M.push(...legalLine(p,1,1),...legalLine(p,1,-1),...legalLine(p,-1,1),...legalLine(p,-1,-1)); }
  else if(p.t==='Q'){ M.push(...legalMoves({...p,t:'R'}),...legalMoves({...p,t:'B'})); }
  else if(p.t==='N'){
    [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(([dr,dc])=>{
      const r=p.r+dr, c=p.c+dc;
      if(r>=0&&r<8&&c>=0&&c<8){
        const q=at(r,c);
        if(!q || q.c!==p.c) M.push([r,c]);
      }
    });
  } else if(p.t==='K'){
    for(let dr=-1;dr<=1;dr++){
      for(let dc=-1;dc<=1;dc++){
        if(dr===0&&dc===0) continue;
        const r=p.r+dr, c=p.c+dc;
        if(r>=0&&r<8&&c>=0&&c<8){
          const q=at(r,c);
          if(!q || q.c!==p.c) M.push([r,c]);
        }
      }
    }
  }
  return M;
}

function redraw(){
  drawBoard(); drawPieces();
}

cvs.addEventListener("click", e=>{
  if(App.over) return;
  if(App.color && turn!==App.color) return; // only act on your turn in multiplayer
  const rect = cvs.getBoundingClientRect();
  const x = e.clientX - rect.left, y = e.clientY - rect.top;
  const c = Math.floor(x/tile), r = Math.floor(y/tile);

  const p = sel || at(r,c);
  if(!p){ sel=null; return; }
  if(!sel){
    if(p.c!==turn){ return; }
    sel=p; return;
  }else{
    const ok = legalMoves(sel).some(([rr,cc])=> rr===r && cc===c);
    if(!ok){ sel=null; return; }
    const victim = at(r,c);
    if(victim){
      // capture
      (victim.c==='white'?capW:capB).push(victim.t);
      PIECES.splice(PIECES.indexOf(victim),1);
      renderCaptured();
    }
    const movePayload = { fr: sel.r, fc: sel.c, tr:r, tc:c, t: sel.t, color: sel.c };
    applyMoveLocal(movePayload, true);
  }
});

function applyMoveLocal
