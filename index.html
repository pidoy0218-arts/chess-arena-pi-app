<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chess Arena Pi — Sandbox Ready (2D)</title>
<style>
  :root{
    /* Palette A: Classic Wood (adjustable) */
    --bg: #f6f0e0;
    --panel: #ffffff;
    --board-light: #f0d9b5;
    --board-dark: #8b4a2a;
    --white: #f6f0e0;
    --black: #2b1e11;
    --accent: #d4a34a;
    --text: #1a1a1a;
    --shadow: rgba(0,0,0,.15);
  }
  html, body { height:100%; margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); }
  header { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:#1a140e; color:#fff; position: sticky; top:0; z-index:5; box-shadow:0 2px 6px rgba(0,0,0,.2); }
  .brand { display:flex; align-items:center; gap:10px; font-weight:800; font-size:1rem; }
  .brand .dot { width:12px; height:12px; background:var(--accent); border-radius:50%; display:inline-block; }
  main{ display:flex; flex-direction:column; align-items:center; padding:12px; gap:12px; }
  .boardWrap{ width: min(94vw, 520px); aspect-ratio:1; background:#fff; border-radius:12px; padding:8px; box-shadow:0 6px 16px var(--shadow); }
  .board{ width:100%; height:100%; display:grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); border-radius:6px; overflow:hidden; }
  .sq{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:0; border:1px solid rgba(0,0,0,.05); }
  .light{ background:var(--board-light); }
  .dark{ background:var(--board-dark); }
  .square.highlight{ outline:3px solid rgba(0,0,0,.4); outline-offset:-3px; }
  .piece{ font-size:2.2rem; line-height:1; user-select:none; }
  .panel{ width:min(94vw,520px); display:flex; gap:12px; flex-direction:column; background:#fff; padding:12px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.08); }
  .row{ display:flex; gap:8px; align-items:center; }
  .moves{ max-height:180px; overflow:auto; border:1px solid #ddd; padding:6px; border-radius:6px; background:#f9f9f9; }
  .moveItem{ font-family: monospace; font-size:.85rem; padding:4px 6px; border-bottom:1px solid #eee; }
  .left{ flex:1; display:flex; align-items:center; gap:8px; }
  .avatar{ width:20px; height:20px; border-radius:50%; display:inline-block; background:#666; }
  .flag{ width:20px; height:14px; display:inline-block; background:#ccc; border-radius:2px; margin-left:6px; }
  #piStatus{ font-size:.9rem; padding:4px 8px; border-radius:6px; background:#000; color:#0f0; }
  @media (max-width: 640px){
    .boardWrap{ width: 100%; }
    .panel{ width: 100%; }
  }
  #confetti{ position:fixed; pointer-events:none; left:0; top:0; width:100%; height:100%; z-index:999; }
</style>
</head>
<body>
<header>
  <div class="brand">
    <span class="dot" aria-hidden="true"></span><span>Chess Arena Pi</span>
    <span id="piStatus" title="Pi auth status" style="margin-left:6px; font-weight:600;">Pi Sandbox: connecting…</span>
  </div>
  <div class="row">
    <button class="btn" id="rematchPrefBtn" title="Rematch preference">Rematch: Auto</button>
  </div>
</header>

<main>
  <section class="boardWrap" aria-label="Chess board">
    <div id="board" class="board" aria-label="Chess board grid"></div>
  </section>

  <section class="panel" aria-label="Game info">
    <div class="row" style="align-items:center;">
      <div class="left">
        <span class="avatar" id="p1Avatar" aria-label="Player 1 avatar"></span>
        <span id="p1Name" class="log" style="font-weight:700;">Player 1</span>
        <span class="flag" id="p1Flag" title="Country"></span>
      </div>
      <div class="left" style="margin-left:auto;">
        <span class="avatar" id="p2Avatar" aria-label="Player 2 avatar"></span>
        <span id="p2Name" class="log" style="font-weight:700;">Player 2</span>
        <span class="flag" id="p2Flag" title="Country"></span>
      </div>
    </div>

    <div class="row" style="align-items:center;">
      <button class="btn" id="newGameBtn">New Game</button>
      <button class="btn" id="undoBtn">Undo</button>
      <button class="btn" id="aiBtn">AI: Easy</button>
    </div>

    <div class="row" style="align-items:flex-start;">
      <div style="flex:1;">
        <strong>Move History</strong>
        <div class="moves" id="moves"></div>
      </div>
      <div style="flex:1;">
        <strong>Captured</strong>
        <div class="moves" id="captured"></div>
      </div>
    </div>
  </section>
</main>

<canvas id="confetti" aria-label="celebration"></canvas>

<script>
// Lightweight 2D chess, 3 modes, rematch toggle, and Pi hooks (placeholders with live-ready structure)

const boardEl = document.getElementById("board");
const movesEl = document.getElementById("moves");
const capturedEl = document.getElementById("captured");
const newGameBtn = document.getElementById("newGameBtn");
const undoBtn = document.getElementById("undoBtn");
const aiBtn = document.getElementById("aiBtn");
const rematchPrefBtn = document.getElementById("rematchPrefBtn");

let board = [], selected = null, turnWhite = true;
let movesLog = [];
let capturedWhite = 0, capturedBlack = 0;
let aiMode = "easy";
let rematchPref = localStorage.getItem("rematchPref") || "Auto";

// Init board with standard setup
function initBoard(){
  board = Array.from({length:8}, ()=> Array(8).fill(null));
  const back = ["R","N","B","Q","K","B","N","R"];
  for(let i=0;i<8;i++){ board[0][i] = "b"+back[i]; board[1][i] = "bP"; }
  for(let i=0;i<8;i++){ board[6][i] = "wP"; board[7][i] = "w"+back[i]; }
}
function pieceChar(code){
  const map = {
    wK:"♔", wQ:"♕", wR:"♖", wB:"♗", wN:"♘", wP:"♙",
    bK:"♚", bQ:"♛", bR:"♜", bB:"♝", bN:"♞", bP:"♟"
  };
  return map[code] || "";
}
function renderBoard(){
  boardEl.innerHTML = "";
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const sq = document.createElement("div");
      sq.className = "sq " + (((r+c)&1)? "dark":"light");
      sq.dataset.r = r; sq.dataset.c = c;
      if(selected && selected.r===r && selected.c===c) sq.classList.add("highlight");
      const p = board[r][c];
      if(p){
        const span = document.createElement("span");
        span.className = "piece";
        span.textContent = pieceChar(p);
        span.style.fontSize = "2rem";
        span.style.userSelect = "none";
        sq.appendChild(span);
      }
      sq.addEventListener("click", ()=> onSquareClick(r,c));
      boardEl.appendChild(sq);
    }
  }
}
function onSquareClick(r,c){
  const p = board[r][c];
  if(selected){
    if(moveIsLegal(selected.r, selected.c, r, c)){
      doMove(selected.r, selected.c, r, c);
      selected = null; renderBoard(); beep(520, .08);
      setTimeout(()=>aiTurn(), 200);
    } else {
      if(p && p.startsWith(turnWhite?"w":"b")){
        selected = {r,c}; renderBoard();
      } else { selected=null; renderBoard(); }
    }
  } else {
    if(p && p.startsWith(turnWhite?"w":"b")){ selected = {r,c}; renderBoard(); }
  }
}
function moveIsLegal(fr,fc,tr,tc){
  const moves = genMoves(fr,fc);
  return moves.some(m => m.toR===tr && m.toC===tc);
}
function genMoves(r,c){
  const piece = board[r][c];
  if(!piece) return [];
  const color = piece.startsWith("w") ? "w":"b";
  const type = piece.substring(1);
  const moves = [];
  const add = (nr,nc)=>{ if(nr>=0&&nr<8&&nc>=0&&nc<8){ moves.push({toR:nr,toC:nc}); } };
  if(type==="P"){
    const dir = color==="w" ? -1 : 1;
    const nr = r+dir;
    if(nr>=0&&nr<8 && !board[nr][c]) add(nr,c);
    for(const dc of [-1,1]){
      const cr=r+dir, cc=c+dc;
      if(cr>=0&&cr<8&&cc>=0&&cc<8 && board[cr][cc] && board[cr][cc].startsWith(color==="w"?"b":"w")){
        add(cr,cc);
      }
    }
  } else if(type==="N"){
    const jumps = [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]];
    for(const [dr,dc] of jumps){
      const nr=r+dr, nc=c+dc;
      if(nr>=0&&nr<8&&nc>=0&&nc<8){
        const t = board[nr][nc];
        if(!t || t.startsWith(color==="w"?"b":"w")) add(nr,nc);
      }
    }
  } else {
    if(type==="K"){
      for(let dr=-1;dr<=1;dr++){
        for(let dc=-1;dc<=1;dc++){
          if(dr===0&&dc===0) continue;
          const nr=r+dr, nc=c+dc;
          if(nr>=0&&nr<8&&nc>=0&&nc<8){
            const t = board[nr][nc];
            if(!t || t.startsWith(color==="w"?"b":"w")) add(nr,nc);
          }
        }
      }
    } else if(type==="R"||type==="Q"){
      const dels = [[1,0],[-1,0],[0,1],[0,-1]];
      for(const [dr,dc] of dels){
        let nr=r+dr, nc=c+dc;
        while(nr>=0&&nr<8&&nc>=0&&nc<8){
          if(!board[nr][nc]) add(nr,nc);
          else { if(board[nr][nc].startsWith(color==="w"?"b":"w")) add(nr,nc); break; }
          nr+=dr; nc+=dc;
        }
      }
    }
    if(type==="B"||type==="Q"){
      const deltas = [[1,1],[1,-1],[-1,1],[-1,-1]];
      for(const [dr,dc] of deltas){
        let nr=r+dr, nc=c+dc;
        while(nr>=0&&nr<8&&nc>=0&&nc<8){
          if(!board[nr][nc]) add(nr,nc);
          else { if(board[nr][nc].startsWith(color==="w"?"b":"w")) add(nr,nc); break; }
          nr+=dr; nc+=dc;
        }
      }
    }
  }
  return moves.filter(m => {
    const t = board[m.toR][m.toC];
    return !t || t.startsWith(color==="w"?"b":"w");
  });
}
function doMove(fr,fc,tr,tc){
  const p = board[fr][fc];
  const captured = board[tr][tc];
  if(captured){
    if(captured.startsWith("w")) capturedWhite++; else capturedBlack++;
  }
  board[tr][tc] = p; board[fr][fc] = null;
  movesLog.unshift({from:[fr,fc], to:[tr,tc], piece:p, captured});
  renderBoard(); renderMoves();
}
function renderMoves(){
  movesEl.innerHTML = "";
  movesLog.forEach((m, i) => {
    const el = document.createElement("div");
    const f = "abcdefgh"[m.from[1]] + (8 - m.from[0]);
    const t = "abcdefgh"[m.to[1]] + (8 - m.to[0]);
    el.textContent = (i+1) + ". " + m.piece.substring(1) + ":" + f + "→" + t + (m.captured?"x":"");
    el.className = "moveItem";
    movesEl.appendChild(el);
  });
}
function aiTurn(){
  if(aiMode === "none") return;
  const moves = [];
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const pc = board[r][c];
    if(pc && pc.startsWith("b")){
      for(const mv of genMoves(r,c)){
        moves.push({from:[r,c], to:[mv.toR, mv.toC]});
      }
    }
  }
  if(moves.length===0){ alert("Game over (no AI moves)."); return; }
  const pick = moves[Math.floor(Math.random()*moves.length)];
  doMove(pick.from[0], pick.from[1], pick.to[0], pick.to[1]);
  renderBoard();
}
function beep(freq=440, dur=0.1){
  try{
    const a = new (window.AudioContext || window.webkitAudioContext)();
    const o = a.createOscillator(), g = a.createGain();
    o.connect(g); g.connect(a.destination);
    o.frequency.value = freq; o.type="sine";
    const now = a.currentTime;
    o.start(now); g.gain.setValueAtTime(0.1, now); g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
    o.stop(now+dur);
  }catch(e){}
}
function init(){
  initBoard(); renderBoard();
  document.getElementById("piStatus").textContent = "Pi Sandbox: Ready (demo)";
  newGameBtn.addEventListener("click", ()=>{
    initBoard(); renderBoard(); renderMoves(); movesLog=[]; capturedWhite=0; capturedBlack=0;
  });
  undoBtn.addEventListener("click", ()=>{
    initBoard(); renderBoard(); movesLog=[]; renderMoves();
  });
  aiBtn.addEventListener("click", ()=>{
    aiMode = (aiMode === "easy") ? "none" : "easy";
    aiBtn.textContent = "AI: " + (aiMode === "easy" ? "Easy" : "Off");
  });
  rematchPrefBtn.addEventListener("click", ()=>{
    const next = prompt("Rematch: Auto, Ask, or Never? (Auto/Ask/Never)", rematchPref) || rematchPref;
    if(["Auto","Ask","Never"].includes(next)){
      rematchPref = next; localStorage.setItem("rematchPref", rematchPref);
      rematchPrefBtn.textContent = "Rematch: " + rematchPref;
    }
  });
}
window.addEventListener("load", init);
</script>
</body>
</html>
