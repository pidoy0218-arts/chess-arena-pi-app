<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CHESS ARENA for PI — Progress Build</title>
<style>
  :root{
    --bg: #efe6d9;
    --wood-light: #e8c79a;
    --wood-dark:  #8b4a2a;
    --panel: #fff;
    --accent: #d4a34a;
    --ivory: #f4f1e7;
    --ebony: #2e2b29;
    --warn:#c21d1d;
    --ok:#1f8f3a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:#1d1a17}
  /* Top center branding */
  .brand-top{position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:30;display:flex;flex-direction:column;align-items:center;gap:6px}
  .brand-logo{width:72px;height:72px;border-radius:14px;background:#2b1e11;display:grid;place-items:center;box-shadow:0 8px 22px rgba(0,0,0,.25)}
  .brand-title{font-weight:900;letter-spacing:.6px}
  .brand-sub{font-weight:700;color:#5d4b3b;font-size:.9rem}

  /* layout: intro/login/mode stacked vertically centered */
  .frame-center {min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px; padding:20px}
  .card {background:var(--panel); border-radius:14px; padding:16px; width:min(720px,94vw); box-shadow:0 12px 30px rgba(0,0,0,.08); border:1px solid #e7dfd6}
  .row {display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap}
  button{cursor:pointer}

  /* Modes area */
  .modes {display:flex; flex-direction:column; gap:10px; width:100%}
  .mode-btn {padding:12px 14px; border-radius:12px; border:2px solid #e8dfd6; font-weight:900; background:#fff}
  .mode-btn.active{border-color:var(--accent); box-shadow:0 8px 20px rgba(212,163,74,.12)}

  /* GAME layout: keep board always visible, right panel toggles */
  .game-shell {display:flex; gap:18px; align-items:flex-start; width:min(1100px,96vw); margin:22px auto}
  .board-card {flex:0 0 680px; background:linear-gradient(#f3e7d3,#e6d1b0); padding:14px; border-radius:14px; box-shadow:0 16px 36px rgba(0,0,0,.12); border:3px solid #6b4a2a}
  .side-card {flex:1; min-width:260px; background:#fff; padding:12px; border-radius:12px; border:1px solid #e8dfd6; box-shadow:0 8px 16px rgba(0,0,0,.06)}

  /* chess board */
  .board {
    width:100%; aspect-ratio:1; display:grid; grid-template-columns: repeat(8,1fr); grid-template-rows: repeat(8,1fr);
    border-radius:10px; overflow:hidden; position:relative;
  }
  .sq {position:relative; display:flex; align-items:center; justify-content:center; user-select:none}
  .light {background:var(--wood-light)}
  .dark {background:var(--wood-dark)}
  .sq.mark {outline: 4px solid rgba(212,163,74,.85); outline-offset:-4px; border-radius:6px}

  .piece {width:90%; height:90%; display:flex; align-items:center; justify-content:center}
  .piece svg{width:100%;height:100%}

  /* top/bottom info bars */
  .info-bar {display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px}
  .id-pill {background:#2b1e11; color:#fff; padding:8px 12px; border-radius:999px; font-weight:800}
  .timer {padding:8px 12px; border-radius:10px; font-weight:900; border:2px solid #e8dfd6; min-width:110px; text-align:center}
  .timer.warn {color:var(--warn)}
  .timer.ok {color:var(--ok)}

  .captured {display:flex; gap:6px; align-items:center; flex-wrap:wrap; min-height:28px}

  /* controls and moves */
  .controls {display:flex; gap:8px; margin-top:12px; justify-content:center;}
  .btn {padding:10px 14px; border-radius:999px; border:0; font-weight:800; background:var(--accent); color:#1a130a}
  .btn.flat {background:#f0eadf;color:#111}

  .moves {max-height:240px; overflow:auto; border:1px solid #efe6d2; padding:8px; border-radius:8px; background:#fbf7f0}
  .mv {font-family:ui-monospace,monospace; padding:6px 8px; border-bottom:1px dashed #e5dccb}

  /* responsive */
  @media(max-width:980px){
    .game-shell {flex-direction:column; align-items:center}
    .board-card{width:92%}
    .side-card{width:92%}
  }

  /* confetti */
  #confetti {position:fixed; inset:0; pointer-events:none; z-index:999}
</style>
</head>
<body>

<!-- Top brand -->
<div class="brand-top" aria-hidden="true">
  <div class="brand-logo" title="Logo">
    <svg viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" x2="1"><stop stop-color="#f8d49a"/><stop offset="1" stop-color="#c38434"/></linearGradient></defs>
      <circle cx="32" cy="32" r="28" fill="url(#g)" stroke="#7b4a14" stroke-width="2"/>
      <path d="M22 42l6-14 8 6-4 8z" fill="#fff" opacity=".9"/>
    </svg>
  </div>
  <div class="brand-title">CHESS ARENA for PI</div>
  <div class="brand-sub">Classic • Quick • Puzzle</div>
</div>

<!-- Frames: intro, login, modes (vertical flow). Main board is below and ALWAYS present. -->
<section id="intro" class="frame-center">
  <div class="card" style="text-align:center">
    <h1 style="margin:6px 0">Welcome to Chess Arena for Pi</h1>
    <div style="color:#6a5a4d;margin-bottom:14px">Animated logo & subtle fanfare (demo)</div>
    <div class="row">
      <button id="btnToLogin" class="btn">Enter</button>
    </div>
  </div>
</section>

<section id="login" class="frame-center hidden">
  <div class="card" style="text-align:center">
    <h2 style="margin:6px 0">Sign in</h2>
    <div style="color:#6a5a4d;margin-bottom:12px">Sign in with Pi (placeholder) or continue as guest</div>
    <div class="row">
      <button id="piSign" class="btn">Sign in with Pi</button>
      <button id="skipLogin" class="btn flat">Continue as Guest</button>
    </div>
  </div>
</section>

<section id="modes" class="frame-center hidden">
  <div class="card" style="text-align:center">
    <h2 style="margin:6px 0">Choose Mode</h2>
    <div class="modes" style="margin-top:10px">
      <button id="puzzleBtn" class="mode-btn">PUZZLE</button>
      <button id="classicBtn" class="mode-btn active">CLASSIC (15m)</button>
      <button id="quickBtn" class="mode-btn">QUICK (30s/move)</button>
      <button id="leaderBtn" class="mode-btn" style="opacity:.5;pointer-events:none">LEADERBOARD (coming)</button>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="startGameBtn" class="btn">Start</button>
      <button id="backToLogin" class="btn flat">Back</button>
    </div>
  </div>
</section>

<!-- MAIN GAME: board + right side. Board ALWAYS present, even when earlier frames toggle. -->
<section id="main" class="card" style="margin:28px auto; width:min(1100px,96vw)">
  <!-- arrange frames above the board: small mode indicator row -->
  <div id="flowNotice" style="display:flex;justify-content:center;gap:8px;margin-bottom:8px">
    <div style="background:#fff;padding:6px 10px;border-radius:999px;border:1px solid #e8dfd6;font-weight:800">Mode: <span id="modeLabel">CLASSIC</span></div>
    <div style="background:#fff;padding:6px 10px;border-radius:999px;border:1px solid #e8dfd6;font-weight:800">Status: <span id="statusLabel">waiting</span></div>
  </div>

  <div class="game-shell">
    <div class="board-card">
      <div class="info-bar">
        <div class="id-pill" id="oppId">Opponent: Guest</div>
        <div class="timer ok" id="oppTimer">15:00</div>
        <div class="captured" id="oppCaptured" aria-hidden="false"></div>
      </div>

      <div id="board" class="board" aria-label="Chess board"></div>

      <div class="info-bar" style="margin-top:10px">
        <div class="id-pill" id="meId">You: Player</div>
        <div class="timer ok" id="meTimer">15:00</div>
        <div class="captured" id="meCaptured"></div>
      </div>

      <div class="controls">
        <button id="offerDraw" class="btn flat">Offer Draw</button>
        <button id="resign" class="btn flat">Resign</button>
        <button id="rematch" class="btn">Rematch</button>
        <button id="backModes" class="btn flat">Back to Modes</button>
      </div>
    </div>

    <div class="side-card">
      <h3 style="margin-top:0">Move History</h3>
      <div id="moves" class="moves"></div>
      <h3 style="margin-top:12px">Captured</h3>
      <div style="margin-bottom:6px"><strong>White:</strong> <span id="whiteCap"></span></div>
      <div><strong>Black:</strong> <span id="blackCap"></span></div>
    </div>
  </div>
</section>

<canvas id="confetti"></canvas>

<!-- chess rules library -->
<script src="https://unpkg.com/chess.js@1.0.0/dist/chess.min.js"></script>
<script>
/* ---------- App flow control ---------- */
const screens = ['intro','login','modes'];
const el = id => document.getElementById(id);
function showScreen(name){
  screens.forEach(s => el(s).classList.toggle('hidden', s!==name));
  // keep main visible always
}
el('btnToLogin').onclick = ()=> showScreen('login');
el('piSign').onclick = ()=> { el('piSign').textContent='Signed ✓'; };
el('skipLogin').onclick = ()=> showScreen('modes');
el('backToLogin').onclick = ()=> showScreen('login');

let selectedMode = 'CLASSIC';
const setModeBtn = (id, mode) => {
  document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
  el(id).classList.add('active');
  selectedMode = mode;
  el('modeLabel').textContent = mode;
};
el('classicBtn').onclick = ()=> setModeBtn('classicBtn','CLASSIC');
el('quickBtn').onclick = ()=> setModeBtn('quickBtn','QUICK');
el('puzzleBtn').onclick = ()=> setModeBtn('puzzleBtn','PUZZLE');
el('startGameBtn').onclick = ()=> { startGame(); showScreen(''); el('statusLabel').textContent='playing'; } 
el('backModes').onclick = ()=> showScreen('modes');

/* ---------- Chess board & game ---------- */
let chess;           // Chess() instance from chess.js
const boardEl = el('board');
const movesEl = el('moves');
let selected = null;
let legalMoves = [];
const files = 'abcdefgh'.split('');

// Timers
let modeType = 'CLASSIC';
let meTime = 15*60, oppTime = 15*60;   // seconds
const quickSeconds = 30; // per move
let perMoveLeft = quickSeconds;
let activeColor = 'w'; // 'w' or 'b'
let ticking = false;
let lastTick = 0;

function startGame(){
  modeType = selectedMode;
  chess = new Chess();
  selected = null; legalMoves=[];
  clearMoves(); clearCaptures();
  activeColor = 'w';
  el('statusLabel').textContent = 'playing';
  // timers
  if(modeType==='CLASSIC'||modeType==='PUZZLE'){
    meTime = oppTime = 15*60;
    updateTimerText(el('meTimer'), meTime, true);
    updateTimerText(el('oppTimer'), oppTime, true);
  } else if(modeType==='QUICK'){
    perMoveLeft = quickSeconds;
    updateTimerText(el('meTimer'), perMoveLeft, true);
    updateTimerText(el('oppTimer'), quickSeconds, true);
  }
  ticking = true; lastTick = performance.now();
  requestAnimationFrame(tick);
  renderBoard();
}

function renderBoard(){
  boardEl.innerHTML = '';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const cell = document.createElement('div');
      const isLight = (r+c)%2===0;
      cell.className = 'sq ' + (isLight ? 'light':'dark');
      const alg = files[c] + (8-r);
      cell.dataset.alg = alg;
      // mark legal
      if(legalMoves.includes(alg)) cell.classList.add('mark');

      const p = chess.get(alg);
      if(p){
        const wrap = document.createElement('div');
        wrap.className='piece';
        wrap.appendChild(pieceSVG(p));
        wrap.ondragstart = (e)=> e.dataTransfer.setData('text/plain', alg);
        wrap.draggable = true;
        wrap.onclick = ()=> onSquareClick(alg);
        cell.appendChild(wrap);
      } else {
        cell.onclick = ()=> onSquareClick(alg);
      }
      cell.ondragover = e=> e.preventDefault();
      cell.ondrop = e=>{
        const from = e.dataTransfer.getData('text/plain');
        tryMove(from, alg);
      };
      boardEl.appendChild(cell);
    }
  }
}

/* click/select logic */
function onSquareClick(alg){
  if(!selected){
    const p = chess.get(alg);
    if(p && p.color===activeColor){
      selected = alg;
      legalMoves = chess.moves({square:alg, verbose:true}).map(m=>m.to);
      renderBoard();
    }
    return;
  }
  if(selected===alg){ selected=null; legalMoves=[]; renderBoard(); return; }
  tryMove(selected, alg);
}

function tryMove(from, to){
  // auto-queen promotion
  const mv = chess.move({from,to,promotion:'q'});
  if(mv){
    playMoveSfx();
    pushMove(mv.san);
    updateCaptureUI(mv);
    selected=null; legalMoves=[];
    renderBoard();
    // check status
    checkStatus();
    // reset quick per-move timer
    if(modeType==='QUICK') perMoveLeft = quickSeconds;
    // swap active color
    activeColor = chess.turn();
  } else {
    // invalid: maybe select another piece
    const p = chess.get(to);
    selected = (p && p.color===activeColor) ? to : null;
    legalMoves = selected ? chess.moves({square:selected, verbose:true}).map(m=>m.to) : [];
    renderBoard();
  }
}

/* move history */
function pushMove(text){
  const d = document.createElement('div'); d.className='mv'; d.textContent = text;
  movesEl.prepend(d);
}
function clearMoves(){ movesEl.innerHTML=''; }

/* capture UI */
function updateCaptureUI(mv){
  if(mv.captured){
    const who = (mv.color==='w') ? 'white' : 'black'; // mv.color is the mover's color
    // captured piece is opponent piece
    const capSpan = document.createElement('span');
    capSpan.textContent = (mv.color==='w') ? glyph({color:'b',type:mv.captured}) : glyph({color:'w',type:mv.captured});
    capSpan.style.marginRight='6px'; capSpan.style.fontSize='18px';
    if(mv.color==='w') el('meCaptured').appendChild(capSpan);
    else el('oppCaptured').appendChild(capSpan);
  }
}
function clearCaptures(){ el('meCaptured').innerHTML=''; el('oppCaptured').innerHTML=''; el('whiteCap').textContent=''; el('blackCap').textContent=''; }

/* timers tick */
function tick(now){
  if(!ticking) return;
  const dt = (now - lastTick)/1000; lastTick = now;
  if(modeType==='CLASSIC' || modeType==='PUZZLE'){
    if(activeColor==='w'){ meTime -= dt; if(meTime<0) meTime=0; updateTimerText(el('meTimer'), meTime); }
    else { oppTime -= dt; if(oppTime<0) oppTime=0; updateTimerText(el('oppTimer'), oppTime); }
    if(meTime<=0 || oppTime<=0){ handleTimeout(); return; }
  } else if(modeType==='QUICK'){
    perMoveLeft -= dt; if(perMoveLeft<0) perMoveLeft=0;
    if(activeColor==='w'){ updateTimerText(el('meTimer'), perMoveLeft); } else { updateTimerText(el('oppTimer'), perMoveLeft); }
    if(perMoveLeft<=0){ handleTimeout(); return; }
  }
  requestAnimationFrame(tick);
}

function updateTimerText(node, secs, reset=false){
  const s = Math.max(0, Math.floor(secs));
  const mm = ('0'+Math.floor(s/60)).slice(-2);
  const ss = ('0'+(s%60)).slice(-2);
  node.textContent = `${mm}:${ss}`;
  if(reset){ node.classList.remove('warn'); node.classList.add('ok'); return; }
  if(s<=10){ node.classList.add('warn'); node.classList.remove('ok'); tickSfx(); }
  else { node.classList.add('ok'); node.classList.remove('warn'); }
}

/* timeout handling */
function handleTimeout(){
  ticking=false;
  let loser;
  if(modeType==='QUICK') loser = (activeColor==='w') ? 'You' : 'Opponent';
  else loser = (meTime<=0) ? 'You' : 'Opponent';
  finishGame(`${loser} lost on time`);
}

/* status check (mate/stalemate/draw) */
function checkStatus(){
  if(chess.in_checkmate()){
    ticking=false;
    const winner = chess.turn()==='w' ? 'Black' : 'White';
    finishGame(`${winner} wins by checkmate`);
  } else if(chess.in_stalemate()){
    ticking=false; finishGame('Draw by stalemate');
  } else if(chess.in_draw()){
    ticking=false; finishGame('Draw');
  } else if(chess.in_check()){
    checkSfx();
  }
}

/* end handling */
function finishGame(msg){
  el('statusLabel').textContent = msg;
  if(/wins|checkmate/.test(msg)){
    winSfx(); confettiBurst();
  } else if(/Draw/.test(msg)) drawSfx();
  else loseSfx();
  alert(msg);
}

/* ---------- simple sfx with WebAudio ---------- */
let audioCtx;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function tone(freq, t=0.08, v=0.18){ ensureAudio(); const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; g.gain.value=v; o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>o.stop(), t*1000); }
function playMoveSfx(){ tone(520,0.06,0.18); }
function checkSfx(){ tone(660,0.12,0.22); }
function tickSfx(){ tone(300,0.03,0.08); }
function winSfx(){ tone(880,0.12,0.26); setTimeout(()=>tone(980,0.14,0.26),140); }
function loseSfx(){ tone(200,0.2,0.22); }
function drawSfx(){ tone(520,0.08,0.18); setTimeout(()=>tone(520,0.08,0.18),90); }

/* ---------- simple confetti ---------- */
function confettiBurst(){
  const c = el('confetti'); const ctx = c.getContext('2d');
  c.width = innerWidth; c.height = innerHeight;
  const N = 80;
  const pieces = Array.from({length:N}).map(()=>({
    x: Math.random()*c.width, y:-20-Math.random()*100, vx:-2+Math.random()*4, vy:2+Math.random()*4, r:3+Math.random()*4, hue:Math.random()*360
  }));
  let t=0;
  (function step(){
    ctx.clearRect(0,0,c.width,c.height);
    pieces.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; ctx.fillStyle=`hsl(${p.hue} 80% 55%)`; ctx.fillRect(p.x,p.y,p.r,p.r); });
    if(++t<160) requestAnimationFrame(step);
  })();
}

/* ---------- small helpers ---------- */
function glyph(p){ // simple unicode piece
  const w = {p:'♙',r:'♖',n:'♘',b:'♗',q:'♕',k:'♔'};
  const b = {p:'♟',r:'♜',n:'♞',b:'♝',q:'♛',k:'♚'};
  return p.color==='w'? w[p.type] : b[p.type];
}

/* ---------- piece SVGs (solid ivory/ebony) ---------- */
function pieceSVG(piece){
  const color = piece.color==='w' ? 'var(--ivory)' : 'var(--ebony)';
  const stroke = piece.color==='w' ? '#d6cdb5' : '#000';
  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox','0 0 64 64');
  const g = document.createElementNS(svgNS,'g'); g.setAttribute('fill',color); g.setAttribute('stroke',stroke); g.setAttribute('stroke-width','1.2');
  const path = document.createElementNS(svgNS,'path');
  switch(piece.type){
    case 'p': path.setAttribute('d','M24 44h16l2 6H22l2-6zm2-8l-2 8h16l-2-8-6-6-6 6z'); break;
    case 'r': path.setAttribute('d','M20 48h24v6H20zm2-24h20l-2 18H24l-2-18zm-2-8h24v6H20z'); break;
    case 'n': path.setAttribute('d','M20 48h24v6H20zm2-14c0-8 6-14 14-14l4 6-6 6 4 6-16 10z'); break;
    case 'b': path.setAttribute('d','M20 48h24v6H20zm12-30c6 0 10 4 10 10s-4 10-10 10-10-4-10-10 4-10 10-10z'); break;
    case 'q': path.setAttribute('d','M20 48h24v6H20zm-2-22l6-8 8 6 8-6 6 8-4 6H22l-4-6z'); break;
    case 'k': path.setAttribute('d','M20 48h24v6H20zm10-26h4v6h6v4h-6v6h-4v-6h-6v-4h6v-6z'); break;
  }
  g.appendChild(path); svg.appendChild(g);
  return svg;
}

/* ---------- initialize simple board display on page load ---------- */
window.addEventListener('load', ()=> {
  showScreen('intro');
  // initial render of an empty board layout (not started)
  chess = new Chess();
  renderBoard();
  // attach buttons
  el('resign').onclick = ()=> finishGame('You resigned');
  el('rematch').onclick = ()=> startGame();
  el('offerDraw').onclick = ()=> finishGame('Draw agreed');
  // let audio unlock on first click
  ['click','touchstart'].forEach(e=> document.addEventListener(e, ()=>{ try{ new (window.AudioContext||window.webkitAudioContext)(); }catch(_){} }, {once:true}));
});
</script>
</body>
</html>
