<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CHESS ARENA for PI</title>
<!-- chess.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/dist/chess.min.js"></script>

<style>
  :root{
    --bg:#0f0f12;            /* app background (dark) */
    --panel:#16181d;         /* cards */
    --accent:#d4a34a;        /* gold */
    --accent-2:#6ec3ff;      /* cyan for highlights */
    --text:#eaecef;
    --muted:#a0a4ad;
    --board-light:#f0d9b5;   /* classic wood light */
    --board-dark:#8b5a2b;    /* classic wood dark */
    --ebony:#1a1a1a;         /* piece dark fill */
    --ivory:#fffdf5;         /* piece light fill */
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto}
  .frame{display:none;min-height:100%;width:100%;padding:24px;display:none;align-items:center;justify-content:center}
  .frame.active{display:flex}
  .stack{width:100%;max-width:980px;display:flex;flex-direction:column;gap:16px;align-items:center}

  /* Top brand */
  .brand{display:flex;flex-direction:column;align-items:center;gap:10px}
  .logo{
    width:84px;height:84px;border-radius:20px;background: radial-gradient(60% 60% at 50% 35%, #ffd36b 0%, #f5a623 50%, #b36712 100%);
    display:grid;place-items:center;box-shadow:0 12px 40px rgba(0,0,0,.35), inset 0 2px 8px rgba(255,255,255,.25);
  }
  .logo svg{width:56px;height:56px;filter: drop-shadow(0 2px 4px rgba(0,0,0,.4))}
  h1{margin:0;font-weight:900;letter-spacing:.5px}
  .subtitle{color:var(--muted);font-weight:600}

  /* Buttons (vertical menu) */
  .btn{
    width:260px;padding:14px 16px;border:0;border-radius:14px;font-weight:800;letter-spacing:.4px;
    color:#0f0f0f;background:var(--accent);cursor:pointer;transition: transform .05s ease, filter .2s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#2b2f39;color:var(--text)}
  .btn.outline{background:transparent;color:var(--text);border:2px solid #2f3642}
  .menu{display:flex;flex-direction:column;gap:10px;align-items:center}

  /* Game layout */
  .gameCard{width:100%;background:var(--panel);border:1px solid #232734;border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .topbar, .bottombar{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .idtag{display:flex;align-items:center;gap:8px;font-weight:800}
  .capture{min-height:26px;font-size:.95rem;color:var(--muted)}
  .timer{font-family:monospace;font-weight:900;font-size:1.2rem;padding:6px 10px;border-radius:10px;background:#1e222c}
  .timer.red{background:#341a1a;color:#ff7676}
  .boardWrap{display:flex;justify-content:center}
  .board{
    width:min(86vmin,640px);aspect-ratio:1;border-radius:12px;overflow:hidden;border:2px solid #5f3b1f;
    display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(8,1fr);
    background:linear-gradient(135deg,#d7b58a 0%,#b27a41 100%);
    box-shadow: inset 0 0 60px rgba(0,0,0,.2);
  }
  .sq{position:relative;display:flex;align-items:center;justify-content:center;user-select:none}
  .light{background:var(--board-light)}
  .dark{background:var(--board-dark)}
  .sq.highlight::after{
    content:"";position:absolute;inset:6px;border:3px solid var(--accent-2);border-radius:10px;pointer-events:none;
    box-shadow:0 0 10px rgba(110,195,255,.7);
  }

  /* SVG piece sizing */
  .piece{width:80%;height:80%;cursor:pointer;touch-action:none}
  .ivory{fill:var(--ivory);stroke:#e8e1cd;stroke-width:2}
  .ebony{fill:var(--ebony);stroke:#3b3b3b;stroke-width:2}

  /* End frame */
  .result{font-size:1.6rem;font-weight:900}

  @media (max-width: 520px){
    .btn{width:95%}
  }
</style>
</head>
<body>

<!-- LOGIN -->
<section id="loginFrame" class="frame active">
  <div class="stack">
    <div class="brand">
      <div class="logo" aria-label="Logo">
        <!-- Animated knight logo -->
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <linearGradient id="gold" x1="0" x2="1">
              <stop offset="0" stop-color="#fff4c9"/><stop offset="1" stop-color="#f0c14b"/>
            </linearGradient>
          </defs>
          <path d="M18 48h28c3 0 4-2 3-4l-3-8c-2-5-7-9-13-9h-4l2-5c.7-1.8-.2-3.2-2.2-3.2h-4.5c-.9 0-1.7.5-2.1 1.3l-3.5 7c-1.5 3-.2 6.1 2.8 7.9l-3.8 2.2c-2.4 1.4-3.5 4.2-2.6 6.8l1.1 3.4c.5 1.7 2 2.8 3.8 2.8Z" fill="url(#gold)"/>
          <circle cx="28.5" cy="19.2" r="2.2" fill="#2b1a05"/>
        </svg>
      </div>
      <h1>CHESS ARENA for PI</h1>
      <div class="subtitle">Login to enter the Arena</div>
    </div>
    <button class="btn" onclick="showFrame('menuFrame')">Login (mock)</button>
  </div>
</section>

<!-- MENU -->
<section id="menuFrame" class="frame">
  <div class="stack">
    <div class="brand" style="gap:6px">
      <h1>Main Menu</h1>
      <div class="subtitle">Choose your path</div>
    </div>
    <div class="menu">
      <button class="btn" onclick="startGame('quick')">QUICK (30s per move)</button>
      <button class="btn" onclick="startGame('classic')">CLASSIC (15m total each)</button>
      <button class="btn secondary" onclick="alert('Invite via Pi SDK (placeholder)')">INVITE (Pi SDK)</button>
      <button class="btn outline" onclick="showFrame('endFrame')">LEADERBOARD (placeholder)</button>
    </div>
  </div>
</section>

<!-- GAME -->
<section id="gameFrame" class="frame">
  <div class="stack">
    <div class="gameCard">
      <div class="topbar">
        <div class="idtag">Opponent • <span id="oppId">guest_123</span></div>
        <div class="timer" id="oppTimer">--:--</div>
        <div class="capture" id="oppCaps"></div>
      </div>

      <div class="boardWrap">
        <div id="board" class="board" aria-label="Chessboard">
          <!-- squares generated by JS -->
        </div>
      </div>

      <div class="bottombar">
        <div class="idtag">You • <span id="youId">you</span></div>
        <div class="timer" id="youTimer">--:--</div>
        <div class="capture" id="youCaps"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn secondary" onclick="resign()">Resign</button>
        <button class="btn secondary" onclick="offerDraw()">Offer Draw</button>
        <button class="btn outline" onclick="endToMenu()">Exit</button>
      </div>
    </div>
  </div>
</section>

<!-- END -->
<section id="endFrame" class="frame">
  <div class="stack">
    <div class="brand" style="gap:12px">
      <div class="result" id="resultText">Game Over</div>
      <div class="subtitle" id="resultReason"></div>
    </div>
    <div class="menu">
      <button class="btn" onclick="showFrame('menuFrame')">Back to Menu</button>
    </div>
  </div>
</section>

<script>
/* ---------- Frame navigation ---------- */
function showFrame(id){
  document.querySelectorAll('.frame').forEach(f=>f.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ---------- Chess engine & UI ---------- */
let game = null;        // chess.js instance
let selected = null;    // {r,c}
let mode = 'quick';     // quick|classic
let youTime = 0, oppTime = 0;
let tick = null;        // interval id
let turn = 'w';         // engine turn (w/b)
let capturedByWhite = [];
let capturedByBlack = [];

/* Build 8x8 board grid + bind handlers */
function buildBoard(){
  const boardEl = document.getElementById('board');
  boardEl.innerHTML = '';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const sq = document.createElement('div');
      sq.className = 'sq ' + (((r+c)&1) ? 'dark' : 'light');
      sq.dataset.r = r; sq.dataset.c = c;
      sq.addEventListener('click', onSquareClick);
      boardEl.appendChild(sq);
    }
  }
}

/* Draw pieces from chess.js FEN */
function drawPieces(){
  const b = game.board(); // 8x8 array
  document.querySelectorAll('.sq').forEach((sq)=>{
    sq.innerHTML = '';
    sq.classList.remove('highlight');
  });

  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const piece = b[r][c];
      if(!piece) continue;
      const holder = document.querySelector(`.sq[data-r="${r}"][data-c="${c}"]`);
      holder.appendChild(makePieceSVG(piece));
    }
  }
  if(selected){
    const {r,c} = selected;
    const selEl = document.querySelector(`.sq[data-r="${r}"][data-c="${c}"]`);
    selEl && selEl.classList.add('highlight');
  }
}

function makePieceSVG(p){
  const color = p.color === 'w' ? 'ivory' : 'ebony';
  const type = p.type; // p r n b q k
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('viewBox','0 0 64 64');
  svg.classList.add('piece');

  const path = document.createElementNS(svgNS,'path');
  path.setAttribute('class', color);

  // Simple filled silhouettes (clean + readable)
  switch(type){
    case 'p': path.setAttribute('d','M28 20h8l4 8v6h-16v-6l4-8Zm-8 22h24v6H20v-6Z'); break;
    case 'r': path.setAttribute('d','M18 48h28v-6h-4V30h-20v12h-4v6Zm4-24h20v-6H22v6Z'); break;
    case 'n': path.setAttribute('d','M18 46h28l-4-10-8-6-6 2-2-6 6-6 8 2 6 6v-6l-4-6h-10l-8 6-4 10v14Z'); break;
    case 'b': path.setAttribute('d','M22 48h20l-4-10 4-6-10-10-10 10 4 6-4 10Z'); break;
    case 'q': path.setAttribute('d','M16 48h32l-6-18 4-6-6-6-8 6-8-6-6 6 4 6-6 18Z'); break;
    case 'k': path.setAttribute('d','M18 48h28l-6-16h-6v-4h6v-6h-6v-6h-8v6h-6v6h6v4h-6l-6 16Z'); break;
  }
  svg.appendChild(path);
  return svg;
}

/* Helpers: board coords <-> algebraic */
function toAlg(r,c){ return 'abcdefgh'[c] + (8 - r); }
function algToRC(al){ const c = al.charCodeAt(0)-97; const r = 8 - parseInt(al[1]); return {r,c}; }

function onSquareClick(e){
  const r = +e.currentTarget.dataset.r;
  const c = +e.currentTarget.dataset.c;
  const board = game.board();
  const here = board[r][c];

  // Select
  if(!selected){
    if(here && ((turn==='w' && here.color==='w') || (turn==='b' && here.color==='b'))){
      selected = {r,c};
      drawPieces();
    }
    return;
  }

  // Attempt move
  const from = toAlg(selected.r, selected.c);
  const to = toAlg(r,c);

  const move = game.move({from, to, promotion: 'q'});
  if(move){
    selected = null;
    turn = game.turn(); // whose turn *after* move
    // capture tracking
    if(move.captured){
      if(move.color === 'w') capturedByWhite.push(move.captured);
      else capturedByBlack.push(move.captured);
      renderCaptures();
    }
    drawPieces();
    checkEnd();
  }else{
    // reselect if clicked your own piece
    if(here && ((turn==='w' && here.color==='w') || (turn==='b' && here.color==='b'))){
      selected = {r,c};
      drawPieces();
    }else{
      selected = null;
      drawPieces();
    }
  }
}

function renderCaptures(){
  document.getElementById('youCaps').textContent = 'You captured: ' + (capturedByWhite.join(' ')||'—');
  document.getElementById('oppCaps').textContent = 'Opponent captured: ' + (capturedByBlack.join(' ')||'—');
}

/* ---------- Modes & Timers ---------- */
function startGame(which){
  mode = which; // 'quick' or 'classic'
  // init engine
  if(typeof Chess !== 'function'){
    alert('Failed to load chess.js (CDN). Please check your internet connection and reload.');
    return;
  }
  game = new Chess(); // standard start
  selected = null; turn = 'w';
  capturedByWhite = []; capturedByBlack = [];
  buildBoard(); drawPieces(); renderCaptures();

  // timers
  clearInterval(tick);
  const youTimerEl = document.getElementById('youTimer');
  const oppTimerEl = document.getElementById('oppTimer');

  if(mode === 'quick'){
    // 30s per move (we time only side-to-move for demo)
    youTime = 30; oppTime = 30;
  }else{
    // 15m each (display mm:ss)
    youTime = 15*60; oppTime = 15*60;
  }
  paintTimers();

  tick = setInterval(()=>{
    if(game.game_over()){ clearInterval(tick); return; }
    if(turn === 'w'){ youTime--; if(mode==='quick' && youTime<=0) return flagLose('You flagged'); }
    else { oppTime--; if(mode==='quick' && oppTime<=0) return flagLose('Opponent flagged (you win)'); }

    // quick last 10s red / classic just show time
    if(mode==='quick'){
      const el = (turn==='w')?youTimerEl:oppTimerEl;
      if((turn==='w'?youTime:oppTime) <= 10) el.classList.add('red'); else el.classList.remove('red');
    }
    paintTimers();

    if(mode==='classic'){
      if(youTime<=0) return flagLose('You flagged (classic)');
      if(oppTime<=0) return flagLose('Opponent flagged (you win, classic)');
    }
  }, 1000);

  showFrame('gameFrame');
}

function paintTimers(){
  const yt = document.getElementById('youTimer');
  const ot = document.getElementById('oppTimer');
  yt.classList.remove('red'); ot.classList.remove('red');

  if(mode==='quick'){
    yt.textContent = (turn==='w'?'▶ ':'‖ ') + youTime + 's';
    ot.textContent = (turn==='b'?'▶ ':'‖ ') + oppTime + 's';
    if(turn==='w' && youTime<=10) yt.classList.add('red');
    if(turn==='b' && oppTime<=10) ot.classList.add('red');
  }else{
    const f = (s)=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
    yt.textContent = (turn==='w'?'▶ ':'‖ ') + f(youTime);
    ot.textContent = (turn==='b'?'▶ ':'‖ ') + f(oppTime);
  }
}

/* ---------- End conditions ---------- */
function checkEnd(){
  if(game.in_checkmate()){
    endGame(game.turn()==='w' ? 'Black wins by checkmate' : 'White wins by checkmate', 'checkmate');
    return;
  }
  if(game.in_stalemate()){
    endGame('Draw by stalemate','stalemate');
    return;
  }
  if(game.in_threefold_repetition()){
    endGame('Draw by threefold repetition','repetition');
    return;
  }
  if(game.insufficient_material()){
    endGame('Draw by insufficient material','material');
    return;
  }
}

function flagLose(reason){
  endGame(reason, 'time');
}

function resign(){
  endGame('You resigned','resign');
}
function offerDraw(){
  endGame('Draw agreed','draw');
}

function endGame(text, reason){
  clearInterval(tick);
  document.getElementById('resultText').textContent = text;
  document.getElementById('resultReason').textContent = `Reason: ${reason}`;
  showFrame('endFrame');
}

function endToMenu(){
  clearInterval(tick);
  showFrame('menuFrame');
}

/* ---------- Boot ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // frames are already set: login is active initially
});
</script>
</body>
</html>
