<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chess Arena â€” for Pi</title>
<meta name="color-scheme" content="dark">
<style>
  :root{
    --bg:#0f1116;
    --panel:#14171f;
    --panel2:#1a2030;
    --ring:#2a3142;
    --accent:#f4b400; /* gold */
    --accent-2:#8bd450;
    --txt:#ffffff;
    --muted:#aeb4bc;

    --wood-light:#d2a679;
    --wood-dark:#8a5a2b;
    --square-light:#e0c39a;
    --square-dark:#a5733b;

    --green:#22c55e;
    --red:#ef4444;
    --blue:#60a5fa;

    --shadow: 0 30px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, Arial;
    background:
      radial-gradient(1200px 800px at 70% -10%, #1a2030 0%, #0f1116 55%) fixed;
    color:var(--txt);
  }
  .wrap{min-height:100%;display:grid;place-items:center;padding:18px}
  .card{
    width:min(1100px, calc(100% - 24px));
    background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
    border:1px solid var(--ring);
    border-radius:22px;
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  /* Top bar */
  .topbar{
    display:flex;align-items:center;gap:16px;
    padding:10px 12px;border-bottom:1px solid var(--ring);
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
  }
  .brand{display:flex;align-items:center;gap:14px}
  .badge{
    width:68px;height:68px;min-width:68px;border-radius:50%;
    display:grid;place-items:center;background:#111;
    box-shadow:0 8px 26px rgba(0,0,0,.4);
  }
  .badge svg{width:44px;height:44px;display:block}
  .btext{display:flex;flex-direction:column;line-height:1.06}
  .title{font-weight:800; letter-spacing:.3px; font-size:22px}
  .forpi{font-size:12px;font-weight:700;color:#fff;opacity:.95}
  .spacer{flex:1}
  .pill{border:1px solid var(--ring);padding:7px 12px;border-radius:999px;background:rgba(255,255,255,.03);font-size:14px}
  .btn{
    border:0;border-radius:999px;padding:10px 16px;font-weight:800;cursor:pointer;
    background:var(--accent);color:#111;box-shadow:0 10px 26px rgba(244,180,0,.25);
  }
  .btn:active{transform:translateY(1px)}
  .top-actions{display:flex;align-items:center;gap:10px}

  /* Layout */
  .body{
    display:grid;gap:18px;padding:16px;
    grid-template-columns: 360px 1fr;
  }
  @media (max-width: 980px){
    .body{grid-template-columns: 1fr}
  }

  /* Left: mode & controls */
  .panel{
    border:1px solid var(--ring);border-radius:18px;padding:14px;
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.08));
  }
  .h{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;
  }
  .h .t{font-size:13px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.08em}
  .tog{display:grid;gap:10px}
  .toggle{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:10px 12px;border-radius:14px;border:1px solid var(--ring);
    background:#0f1218;cursor:pointer;user-select:none;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.02);
  }
  .toggle .left{display:flex;align-items:center;gap:10px}
  .dot{width:12px;height:12px;border-radius:50%;background:#2a3142;transition:.15s}
  .toggle.active .dot{background:var(--accent-2); box-shadow:0 0 10px 2px rgba(139,212,80,.35)}
  .lab{font-weight:800; letter-spacing:.2px}
  .badge-mini{
    font-size:11px;font-weight:800;padding:6px 8px;border-radius:999px;color:#111;background:#fff;
    box-shadow:0 6px 16px rgba(0,0,0,.25);
  }
  .badge-classic{background:#6aa9ff;color:#111}
  .badge-blitz{background:#ff6aa9;color:#111}
  .badge-ai{background:#a78bfa;color:#111}

  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn2{
    border:1px solid var(--ring);background:#0f1218;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;
  }
  .btn2.primary{border:0;background:var(--blue);color:#0b1220;font-weight:800}
  .note{font-size:12px;color:var(--muted);margin-top:8px}

  /* Right: Board area */
  .board-wrap{
    display:grid;grid-template-columns: auto 280px; gap:16px;align-items:start;
  }
  @media (max-width: 1200px){
    .board-wrap{grid-template-columns: 1fr}
  }

  /* Wooden table (frame around board) */
  .table{
    padding:18px;border-radius:16px;border:1px solid rgba(0,0,0,.5);
    background:
      linear-gradient(135deg, rgba(0,0,0,.25), rgba(255,255,255,.05)) padding-box,
      repeating-linear-gradient(  0deg, var(--wood-light), var(--wood-light) 14px, var(--wood-dark) 15px, var(--wood-dark) 29px) border-box;
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.15),
      0 14px 40px rgba(0,0,0,.55);
  }

  /* Board proper */
  .board{
    width:min(640px, 90vw); aspect-ratio:1/1;
    background:
      linear-gradient(45deg, rgba(0,0,0,.06), rgba(255,255,255,.04)) border-box,
      conic-gradient(from 90deg at 25% 25%, var(--square-light) 0 25%, var(--square-dark) 0 50%, var(--square-light) 0 75%, var(--square-dark) 0 100%) 0/25% 25%;
    position:relative;border-radius:10px;overflow:hidden;border:1px solid rgba(0,0,0,.4);
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.05), inset 0 0 40px rgba(0,0,0,.3);
  }
  .coord{
    position:absolute; inset:0; pointer-events:none; font-size:10px; color:rgba(0,0,0,.55);
    mix-blend-mode:multiply; font-weight:700;
  }
  .coord div{position:absolute;padding:3px}
  .coord .a{left:4px;bottom:4px}
  .coord .h{right:4px;top:4px}

  /* Squares overlay for highlights */
  .sq{
    position:absolute; width:12.5%; height:12.5%;
    outline: 0 solid transparent;
  }
  .sq.hl-move{box-shadow: inset 0 0 0 3px rgba(96,165,250,.9)}
  .sq.hl-capture{box-shadow: inset 0 0 0 3px rgba(239,68,68,.95)}
  .sq.target{background: radial-gradient(circle at center, rgba(96,165,250,.8) 0 18%, transparent 19%)}

  /* Pieces */
  .piece{
    position:absolute; width:12.5%; height:12.5%;
    display:grid; place-items:center;
    transition: transform .08s ease;
    cursor:grab;
  }
  .piece.dragging{cursor:grabbing; z-index:3; transform:scale(1.06)}
  .piv{width:78%; height:78%}
  .w .piv{filter: drop-shadow(0 2px 0 rgba(0,0,0,.35))}
  .b .piv{filter: drop-shadow(0 2px 0 rgba(0,0,0,.6))}
  .ghost{opacity:.6; pointer-events:none}

  /* Side panel (status, timers, actions) */
  .side{
    border:1px solid var(--ring);border-radius:16px;padding:12px;background:rgba(255,255,255,.02)
  }
  .sec{padding:10px;border-radius:12px;background:rgba(255,255,255,.02);border:1px solid var(--ring);margin-bottom:10px}
  .sec h3{margin:0 0 8px 0;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  .timer{
    display:flex;justify-content:space-between;gap:10px
  }
  .clock{flex:1;border:1px solid var(--ring);border-radius:10px;padding:10px;text-align:center;font-weight:800;font-size:18px;background:#0f1218}
  .status{font-size:14px;color:#e5e7eb}
  .sep{height:8px}

  /* Intro splash */
  .splash{
    position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.6);
    backdrop-filter: blur(2px); z-index:9;
  }
  .splash-card{
    width:min(520px, 92vw); text-align:center; padding:28px; border-radius:18px; border:1px solid var(--ring);
    background:linear-gradient(180deg, #111418, #0d1015);
    box-shadow:var(--shadow)
  }
  .slogo{
    width:130px;height:130px;border-radius:50%;display:grid;place-items:center;background:#0b0e13;margin:0 auto 14px;
    box-shadow:0 12px 40px rgba(0,0,0,.5);
    animation: pop .9s cubic-bezier(.2,1.4,.42,1) .12s both;
  }
  .slogo svg{width:90px;height:90px}
  .stitle{font-weight:900;font-size:32px;letter-spacing:.3px;line-height:1.04}
  .ssub{margin-top:6px;font-size:12px;color:#e9e9e9;opacity:.9}
  .sbtn{margin-top:16px}
  @keyframes pop{
    0%{transform:scale(.6);opacity:0}
    55%{transform:scale(1.07);opacity:1}
    100%{transform:scale(1)}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">

    <!-- Top bar -->
    <div class="topbar">
      <div class="brand">
        <div class="badge" aria-hidden="true">
          <!-- Trademark-safe: Knight in a gold circle -->
          <svg viewBox="0 0 100 100" role="img" aria-label="Knight crest">
            <circle cx="50" cy="50" r="45" fill="#f4b400"/>
            <path d="M63 72H37c-1 0-2-1-2-2 0-7 2-12 9-15-3-1-5-4-5-7 0-6 6-11 12-11 3 0 6 1 8 3 1-3 3-4 6-5 1 0 2 1 1 2-2 4-1 8 1 11 1 2 2 3 2 5 0 1-1 2-2 2h-1c-3 0-5 1-7 2-4 2-6 5-7 11 0 1-1 2-2 2Z" fill="#fff" stroke="#111" stroke-width="1"/>
            <circle cx="57" cy="45" r="2" fill="#111"/>
          </svg>
        </div>
        <div class="btext">
          <div class="title">Chess Arena</div>
          <div class="forpi">for Pi</div>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="top-actions">
        <span id="userPill" class="pill" style="display:none"></span>
        <button id="loginBtn" class="btn">Sign in with Pi</button>
      </div>
    </div>

    <!-- Body -->
    <div class="body">

      <!-- Left controls -->
      <div class="panel">
        <div class="h">
          <div class="t">Modes & Tools</div>
        </div>

        <div class="tog" id="modeToggles">
          <div class="toggle active" data-mode="classic" tabindex="0" role="button" aria-pressed="true">
            <div class="left"><div class="dot"></div><div class="lab">Classic</div></div>
            <span class="badge-mini badge-classic">40/20</span>
          </div>
          <div class="toggle" data-mode="blitz" tabindex="0" role="button" aria-pressed="false">
            <div class="left"><div class="dot"></div><div class="lab">Blitz</div></div>
            <span class="badge-mini badge-blitz">3|0</span>
          </div>
          <div class="toggle" data-mode="ai" tabindex="0" role="button" aria-pressed="false">
            <div class="left"><div class="dot"></div><div class="lab">Vs AI</div></div>
            <span class="badge-mini badge-ai">Beta</span>
          </div>
        </div>

        <div class="row">
          <button id="newGame" class="btn2 primary">New game</button>
          <button id="flipBoard" class="btn2">Flip board</button>
          <button id="resetBoard" class="btn2">Reset position</button>
        </div>
        <div class="note" id="modeNote">Classic selected. After sign-in, multiplayer + sandbox unlock.</div>
      </div>

      <!-- Right: board + side widgets -->
      <div class="board-wrap">
        <div class="table">
          <div id="board" class="board" aria-label="Chessboard"></div>
        </div>
        <div class="side">
          <div class="sec">
            <h3>Status</h3>
            <div id="status" class="status">White to move.</div>
          </div>
          <div class="sec">
            <h3>Timers</h3>
            <div class="timer">
              <div id="clockB" class="clock">05:00</div>
              <div id="clockW" class="clock">05:00</div>
            </div>
          </div>
          <div class="sec">
            <h3>Actions</h3>
            <div class="row">
              <button id="undoMove" class="btn2">Undo</button>
              <button id="clearHL" class="btn2">Clear highlights</button>
            </div>
          </div>
          <div class="note">Drag pieces. Legal moves highlight. No check/checkmate yet (Phase 2 brings full rules & online pairing).</div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Intro splash -->
<div id="splash" class="splash">
  <div class="splash-card">
    <div class="slogo">
      <svg viewBox="0 0 100 100" role="img" aria-label="Knight crest">
        <circle cx="50" cy="50" r="45" fill="#f4b400"/>
        <path d="M63 72H37c-1 0-2-1-2-2 0-7 2-12 9-15-3-1-5-4-5-7 0-6 6-11 12-11 3 0 6 1 8 3 1-3 3-4 6-5 1 0 2 1 1 2-2 4-1 8 1 11 1 2 2 3 2 5 0 1-1 2-2 2h-1c-3 0-5 1-7 2-4 2-6 5-7 11 0 1-1 2-2 2Z" fill="#fff" stroke="#111" stroke-width="1"/>
        <circle cx="57" cy="45" r="2" fill="#111"/>
      </svg>
    </div>
    <div class="stitle">Chess Arena</div>
    <div class="ssub">for Pi</div>
    <div class="sbtn"><button id="enterApp" class="btn">Enter</button></div>
  </div>
</div>

<script>
/* ------------------------- Pi SDK sign-in hook -------------------------- */
const loginBtn = document.getElementById('loginBtn');
const userPill = document.getElementById('userPill');
loginBtn.addEventListener('click', async ()=>{
  if(!window.Pi || !window.Pi.authenticate){
    alert('Open this in Pi Browser Sandbox to Sign in with Pi.');
    return;
  }
  try{
    const scopes = ['username','payments'];
    const onIncompletePaymentFound = p => console.log('incomplete payment', p);
    const auth = await window.Pi.authenticate(scopes, onIncompletePaymentFound);
    const username = auth?.user?.username || 'pioneer';
    userPill.textContent = '@'+username;
    userPill.style.display = 'inline-flex';
    loginBtn.style.display = 'none';

    // Optional backend verification (enable when wired):
    // await fetch('/user/signin', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ authResult: auth }) });

    document.getElementById('status').textContent = 'Signed in as @'+username+'. Multiplayer & sandbox enabled.';
  }catch(e){
    console.error(e); alert('Pi sign-in failed.');
  }
});

/* ------------------------------ Splash --------------------------------- */
document.getElementById('enterApp').onclick = ()=> document.getElementById('splash').remove();

/* --------------------------- Mode toggles ------------------------------- */
const note = document.getElementById('modeNote');
document.querySelectorAll('#modeToggles .toggle').forEach(el=>{
  el.addEventListener('click', ()=>{
    document.querySelectorAll('#modeToggles .toggle').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    const m = el.dataset.mode;
    note.textContent =
      m==='classic' ? 'Classic selected.' :
      m==='blitz'   ? 'Blitz selected (3|0).' :
      'Vs AI (local engine coming).';
  });
});

/* --------------------------- Chess engine lite -------------------------- */
/* Turn-based, legal moves per piece, captures, highlights.
   No: check, checkmate, castle, en passant, promo auto -> simple queen promo.
*/
const boardEl = document.getElementById('board');
const statusEl = document.getElementById('status');
const clockW = document.getElementById('clockW');
const clockB = document.getElementById('clockB');

let flipped = false;
let turn = 'w';
let history = [];

const startFEN = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR";
let pos = fenToArray(startFEN);

function fenToArray(fen){
  const rows = fen.split('/');
  const out = [];
  for(const r of rows){
    const row = [];
    for(const ch of r){
      if(/\d/.test(ch)){ for(let i=0;i<+ch;i++) row.push(''); }
      else row.push(ch);
    }
    out.push(row);
  }
  return out;
}

function toFEN(arr){
  return arr.map(r=>{
    let s=''; let cnt=0;
    for(const c of r){
      if(!c) cnt++;
      else{ if(cnt){s+=cnt;cnt=0} s+=c; }
    }
    if(cnt) s+=cnt;
    return s;
  }).join('/');
}

/* --- Pieces SVG (ivory/ebony) --- */
function svgPiece(code){
  const isWhite = code === code.toUpperCase();
  const t = code.toLowerCase();
  const fill = isWhite ? '#fff7e6' : '#1b1b1b';
  const stroke = isWhite ? '#c9b795' : '#444';
  const crown = isWhite ? '#e9dfc9' : '#2a2a2a';

  // simple stylized set
  const paths = {
    p: `<path d="M32 60c-8 0-8-12 0-12h36c8 0 8 12 0 12H32Z" fill="${fill}" stroke="${stroke}" stroke-width="2"/>
        <path d="M36 60h28v10c0 6-6 10-14 10s-14-4-14-10V60Z" fill="${fill}" stroke="${stroke}" stroke-width="2"/>`,
    r: `<path d="M28 32h12l4 8h12l4-8h12v10H28V32Z" fill="${fill}" stroke="${stroke}" stroke-width="2"/>
        <rect x="30" y="42" width="40" height="30" rx="4" fill="${fill}" stroke="${stroke}" stroke-width="2"/>`,
    n: `<path d="M36 70c0-16 8-26 26-30l8 12-8 6 6 8-10 8H44c-4 0-8-2-8-4Z" fill="${fill}" stroke="${stroke}" stroke-width="2"/>`,
    b: `<path d="M50 28c10 10 14 18 14 26 0 10-8 18-14 18s-14-8-14-18c0-8 4-16 14-26Z" fill="${fill}" stroke="${stroke}" stroke-width="2"/>
        <circle cx="50" cy="40" r="3" fill="${stroke}"/>`,
    q: `<path d="M28 30l8 16 10-16 6 18 6-18 10 16 8-16 0 14H28V30Z" fill="${crown}" stroke="${stroke}" stroke-width="2"/>
        <path d="M30 44h40v24c0 8-8 12-20 12s-20-4-20-12V44Z" fill="${fill}" stroke="${stroke}" stroke-width="2"/>`,
    k: `<path d="M48 26h4v8h8v4h-8v8h-4v-8h-8v-4h8v-8Z" fill="${crown}"/>
        <path d="M30 46h40v20c0 10-8 16-20 16s-20-6-20-16V46Z" fill="${fill}" stroke="${stroke}" stroke-width="2"/>`
  };
  return `<svg class="piv" viewBox="0 0 100 100">${paths[t]}</svg>`;
}

/* --- Helpers --- */
function clearBoard(){
  boardEl.innerHTML = `
    <div class="coord"><div class="a">a1</div><div class="h">h8</div></div>
  `;
}
function sqId(r,c){ return (r*8+c); }
function rcFromId(id){ return [Math.floor(id/8), id%8]; }
function algebraic(r,c){ return 'abcdefgh'[c] + (flipped ? r+1 : 8-r); }

function render(){
  clearBoard();
  // highlight map reset
  const frg = document.createDocumentFragment();

  // squares overlay to receive highlights & targets (optional)
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const s = document.createElement('div');
      s.className = 'sq';
      const [x,y] = xy(r,c);
      s.style.left = x; s.style.top = y;
      s.dataset.id = sqId(r,c);
      frg.appendChild(s);
    }
  }

  // pieces
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const code = pos[r][c];
      if(!code) continue;
      const p = document.createElement('div');
      p.className = 'piece ' + (code === code.toUpperCase() ? 'w':'b');
      const [x,y] = xy(r,c);
      p.style.left = x; p.style.top = y;
      p.dataset.id = sqId(r,c);
      p.dataset.code = code;
      p.innerHTML = svgPiece(code);
      makeDraggable(p);
      frg.appendChild(p);
    }
  }

  boardEl.appendChild(frg);
  statusEl.textContent = (turn==='w'?'White':'Black') + ' to move.';
}

function xy(r,c){
  const rr = flipped ? 7-r : r;
  const cc = flipped ? 7-c : c;
  return [ (cc*12.5)+'%', (rr*12.5)+'%' ];
}

function inBounds(r,c){ return r>=0 && r<8 && c>=0 && c<8; }
function colorAt(r,c){
  const v = pos[r][c];
  return v ? (v===v.toUpperCase() ? 'w' : 'b') : '';
}
function movesFor(r,c){
  const v = pos[r][c]; if(!v) return [];
  const me = (v===v.toUpperCase() ? 'w':'b');
  const t = v.toLowerCase();
  const out = [];
  const push = (rr,cc,capOK=true)=>{
    if(!inBounds(rr,cc)) return false;
    const col = colorAt(rr,cc);
    if(!col){ out.push([rr,cc,false]); return true; }
    if(capOK && col!==me){ out.push([rr,cc,true]); }
    return false;
  };

  if(t==='p'){
    const dir = (me==='w'?-1:1);
    const start = (me==='w'?6:1);
    // one step
    if(inBounds(r+dir,c) && !pos[r+dir][c]) out.push([r+dir,c,false]);
    // two step
    if(r===start && !pos[r+dir][c] && !pos[r+2*dir][c]) out.push([r+2*dir,c,false]);
    // captures
    for(const dc of [-1,1]){
      const rr = r+dir, cc = c+dc;
      if(inBounds(rr,cc) && pos[rr][cc] && colorAt(rr,cc)!==me) out.push([rr,cc,true]);
    }
  }
  if(t==='n'){
    const deltas = [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];
    for(const [dr,dc] of deltas){
      const rr=r+dr, cc=c+dc; if(!inBounds(rr,cc)) continue;
      const col = colorAt(rr,cc);
      if(!col || col!==me) out.push([rr,cc, !!col]);
    }
  }
  const slide = (dirs)=>{
    for(const [dr,dc] of dirs){
      let rr=r+dr, cc=c+dc;
      while(true){
        if(!inBounds(rr,cc)) break;
        const col = colorAt(rr,cc);
        if(!col){ out.push([rr,cc,false]); rr+=dr; cc+=dc; continue; }
        if(col!==me){ out.push([rr,cc,true]); }
        break;
      }
    }
  };
  if(t==='b') slide([[1,1],[1,-1],[-1,1],[-1,-1]]);
  if(t==='r') slide([[1,0],[-1,0],[0,1],[0,-1]]);
  if(t==='q'){ slide([[1,1],[1,-1],[-1,1],[-1,-1],[1,0],[-1,0],[0,1],[0,-1]]); }
  if(t==='k'){
    for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
      if(!dr && !dc) continue;
      const rr=r+dr, cc=c+dc; if(!inBounds(rr,cc)) continue;
      const col=colorAt(rr,cc); if(!col || col!==me) out.push([rr,cc, !!col]);
    }
  }
  // filter to current turn
  return out;
}

/* --- Drag & drop --- */
let drag = null;
let legal = [];

function makeDraggable(el){
  el.onpointerdown = (e)=>{
    const id = +el.dataset.id;
    const [r,c] = rcFromId(id);
    const code = el.dataset.code;
    const me = (code===code.toUpperCase()?'w':'b');
    if(me!==turn) return;

    legal = movesFor(r,c);
    highlight(legal);

    drag = {
      el, startId:id, startX:e.clientX, startY:e.clientY,
      origLeft: el.style.left, origTop: el.style.top
    };
    el.setPointerCapture(e.pointerId);
    el.classList.add('dragging');
  };
  el.onpointermove = (e)=>{
    if(!drag) return;
    const dx = e.clientX - drag.startX;
    const dy = e.clientY - drag.startY;
    const b = boardEl.getBoundingClientRect();
    const w = b.width/8, h=b.height/8;
    const left = parseFloat(drag.origLeft)/100 * b.width + dx;
    const top  = parseFloat(drag.origTop)/100 * b.height + dy;
    drag.el.style.left = (left/b.width*100)+'%';
    drag.el.style.top  = (top /b.height*100)+'%';

    // show target circle
    document.querySelectorAll('.sq').forEach(s=>s.classList.remove('target'));
    const cc = Math.min(7, Math.max(0, Math.floor((left + w/2)/w)));
    const rr = Math.min(7, Math.max(0, Math.floor((top  + h/2)/h)));
    const [r,c] = flipped ? [7-rr, 7-cc] : [rr,cc];
    const tid = sqId(r,c);
    if(legal.find(m=>m[0]===r && m[1]===c)){
      const sq = document.querySelector('.sq[data-id="'+tid+'"]');
      if(sq) sq.classList.add('target');
    }
  };
  el.onpointerup = (e)=>{
    if(!drag) return;
    el.classList.remove('dragging');
    const b = boardEl.getBoundingClientRect();
    const w = b.width/8, h=b.height/8;
    const left = parseFloat(el.style.left)/100 * b.width;
    const top  = parseFloat(el.style.top)/100 * b.height;
    const cc = Math.min(7, Math.max(0, Math.floor((left + w/2)/w)));
    const rr = Math.min(7, Math.max(0, Math.floor((top  + h/2)/h)));
    const [r2,c2] = flipped ? [7-rr, 7-cc] : [rr,cc];

    const [r1,c1] = rcFromId(drag.startId);
    const mv = legal.find(m=>m[0]===r2 && m[1]===c2);

    clearHighlights();

    if(mv){
      // move piece
      const code = pos[r1][c1];
      history.push(toFEN(pos));
      pos[r1][c1]='';
      // simple promotion to queen on last rank
      if(code.toLowerCase()==='p' && (r2===0 || r2===7)){
        pos[r2][c2] = (code===code.toUpperCase() ? 'Q':'q');
      } else {
        pos[r2][c2]=code;
      }
      turn = (turn==='w'?'b':'w');
      render();
    }else{
      // snap back
      el.style.left = drag.origLeft; el.style.top = drag.origTop;
    }
    drag = null;
  };
}

function clearHighlights(){
  document.querySelectorAll('.sq').forEach(s=>s.classList.remove('hl-move','hl-capture','target'));
}
function highlight(moves){
  clearHighlights();
  for(const [r,c,cap] of moves){
    const id = sqId(r,c);
    const el = document.querySelector('.sq[data-id="'+id+'"]');
    if(!el) continue;
    el.classList.add(cap ? 'hl-capture' : 'hl-move');
  }
}

/* --- Controls --- */
document.getElementById('newGame').onclick = ()=>{
  pos = fenToArray(startFEN);
  history = [];
  turn = 'w';
  render();
};
document.getElementById('resetBoard').onclick = ()=>{
  pos = fenToArray(startFEN);
  render();
};
document.getElementById('flipBoard').onclick = ()=>{
  flipped = !flipped;
  render();
};
document.getElementById('undoMove').onclick = ()=>{
  if(!history.length) return;
  pos = fenToArray(history.pop());
  turn = (turn==='w'?'b':'w');
  render();
};
document.getElementById('clearHL').onclick = clearHighlights;

/* --- Init --- */
render();
</script>
</body>
</html>
