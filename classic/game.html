<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chess Arena – Classic Sandbox</title>
<style>
  body { font-family: Arial, sans-serif; background:#f5f1ea; display:flex; flex-direction:column; align-items:center; margin:0; padding:20px; }
  #player2,#player1{ font-weight:bold; margin:10px; font-size:18px; }
  #board{ display:grid; grid-template-columns:repeat(8,60px); grid-template-rows:repeat(8,60px); border:3px solid #333; box-shadow:0 4px 8px rgba(0,0,0,0.2); }
  .square{ width:60px; height:60px; display:flex; justify-content:center; align-items:center; font-size:36px; cursor:pointer; user-select:none; transition:background 0.2s; }
  .light{ background:#f0d9b5; }
  .dark{ background:#b58863; }
  .selected{ outline:3px solid #2196f3; }
  #timers{ display:flex; justify-content:space-between; width:500px; margin:10px 0; font-size:18px; font-weight:bold; }
  #message{ margin-top:15px; font-size:20px; color:red; font-weight:bold; }
  #rematchModal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  #rematchContent{ background:#fff; padding:20px; border-radius:10px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.3);}
  #rematchContent button{ margin:10px; padding:10px 20px; font-size:16px; font-weight:bold; cursor:pointer; }
  #leaderboard{ display:none; flex-direction:column; align-items:center; margin-top:20px; }
  #leaderboard button{ margin-top:15px; padding:10px 20px; font-size:16px; cursor:pointer; font-weight:bold; }
</style>
</head>
<body>

<div id="player2">Player 2: [ID]</div>
<div id="timers">
  <div>Player1: <span id="timer1">10:00</span></div>
  <div>Player2: <span id="timer2">10:00</span></div>
</div>
<div id="board"></div>
<div id="player1">Player 1: [ID]</div>
<div id="message"></div>

<!-- Rematch Popup -->
<div id="rematchModal">
  <div id="rematchContent">
    <p>Do you want a rematch?</p>
    <button id="rematchBtn">Rematch (Pay & Play)</button>
    <button id="skipBtn">No</button>
  </div>
</div>

<!-- Leaderboard Placeholder -->
<div id="leaderboard">
  <h2>Leaderboard</h2>
  <p>Personal Best: 1200 pts</p>
  <p>SDK Rank: 15</p>
  <button id="backLobbyBtn">Back to Lobby / New Match</button>
</div>

<script>
const boardEl = document.getElementById('board');
const messageEl = document.getElementById('message');
const rematchModal = document.getElementById('rematchModal');
const leaderboard = document.getElementById('leaderboard');

let selected = null;
let turn = 'w';
let timer1 = 600, timer2 = 600; // seconds
let timerInterval = null;
let rematchChosen = false;

// Chess pieces Unicode
const pieces = { w: { K:'♔',Q:'♕',R:'♖',B:'♗',N:'♘',P:'♙' }, b: { K:'♚',Q:'♛',R:'♜',B:'♝',N:'♞',P:'♟︎' } };

// Initial board setup
let board = [
  ['bR','bN','bB','bQ','bK','bB','bN','bR'],
  ['bP','bP','bP','bP','bP','bP','bP','bP'],
  ['','','','','','','',''],
  ['','','','','','','',''],
  ['','','','','','','',''],
  ['','','','','','','',''],
  ['wP','wP','wP','wP','wP','wP','wP','wP'],
  ['wR','wN','wB','wQ','wK','wB','wN','wR']
];

// --- BOARD DRAWING ---
function drawBoard(){
  boardEl.innerHTML='';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const sq=document.createElement('div');
      sq.className='square '+((r+c)%2===0?'light':'dark');
      sq.dataset.row=r; sq.dataset.col=c;
      if(board[r][c]){
        const color=board[r][c][0], type=board[r][c][1];
        sq.textContent=pieces[color][type];
      }
      if(selected && selected[0]===r && selected[1]===c) sq.classList.add('selected');
      sq.addEventListener('click',()=>clickSquare(r,c));
      boardEl.appendChild(sq);
    }
  }
}

// --- CLICK LOGIC ---
function clickSquare(r,c){
  if(rematchModal.style.display==='flex') return; // block clicks during rematch modal
  const piece=board[r][c];
  if(selected){
    const [sr,sc]=selected;
    if(isLegalMove(sr,sc,r,c)){
      movePiece(sr,sc,r,c);
      selected=null; drawBoard(); checkGameState(); switchTurn();
    } else { selected=null; drawBoard(); }
  } else if(piece && piece[0]===turn) { selected=[r,c]; drawBoard(); }
}

// --- MOVE VALIDATION ---
function isLegalMove(sr,sc,r,c){
  const piece=board[sr][sc];
  if(!piece || piece[0]!==turn) return false;
  const target=board[r][c]; if(target && target[0]===turn) return false;
  const type=piece[1], dr=r-sr, dc=c-sc;
  switch(type){
    case 'P': const dir=turn==='w'?-1:1;
      if(dc===0 && dr===dir && !target) return true;
      if(dc===0 && dr===2*dir && ((sr===6 && turn==='w')||(sr===1 && turn==='b')) && !target && !board[sr+dir][sc]) return true;
      if(Math.abs(dc)===1 && dr===dir && target && target[0]!==turn) return true;
      return false;
    case 'R': if(dr===0||dc===0) return isClearPath(sr,sc,r,c); return false;
    case 'N': return Math.abs(dr*dc)===2;
    case 'B': if(Math.abs(dr)===Math.abs(dc)) return isClearPath(sr,sc,r,c); return false;
    case 'Q': if(dr===0||dc===0||Math.abs(dr)===Math.abs(dc)) return isClearPath(sr,sc,r,c); return false;
    case 'K': if(Math.abs(dr)<=1 && Math.abs(dc)<=1) return true;
      if(dr===0 && Math.abs(dc)===2) return canCastle(sr,sc,dc>0); return false;
  }
  return false;
}

function isClearPath(sr,sc,r,c){ const dr=r>sr?1:r<sr?-1:0; const dc=c>sc?1:c<sc?-1:0; let x=sr+dr,y=sc+dc; while(x!==r||y!==c){ if(board[x][y]) return false; x+=dr;y+=dc; } return true; }
function canCastle(r,c,kingside){ /* simplified as before */ return false; }

function movePiece(sr,sc,r,c){
  const piece=board[sr][sc], type=piece[1];
  board[r][c]=piece; board[sr][sc]='';
  if(type==='P' && (r===0||r===7)) board[r][c]=piece[0]+'Q';
}

// --- TURN & CHECK ---
function switchTurn(){ turn=turn==='w'?'b':'w'; }

function checkGameState(){
  if(isCheckmate(turn)) triggerGameEnd((turn==='w'?'Black':'White')+' wins by checkmate!');
  else if(isStalemate(turn)) triggerGameEnd('Draw by stalemate');
  else messageEl.textContent='';
}

function isCheckmate(color){ const moves=getAllLegalMoves(color); return moves.length===0 && isKingInCheck(color); }
function isStalemate(color){ const moves=getAllLegalMoves(color); return moves.length===0 && !isKingInCheck(color); }
function isKingInCheck(color){ /* simplified */ return false; }
function getAllLegalMoves(color){ return []; }

// --- TIMERS ---
function startTimers(){ if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    if(turn==='w') timer1--; else timer2--;
    document.getElementById('timer1').textContent=formatTime(timer1);
    document.getElementById('timer2').textContent=formatTime(timer2);
    if(timer1<=0 || timer2<=0){ clearInterval(timerInterval); triggerGameEnd(timer1<=0?'Player 2 wins on time':'Player 1 wins on time'); }
  },1000);
}
function formatTime(sec){ const m=Math.floor(sec/60).toString().padStart(2,'0'); const s=(sec%60).toString().padStart(2,'0'); return `${m}:${s}`; }

// --- REMATCH / LEADERBOARD FLOW ---
function triggerGameEnd(msg){
  messageEl.textContent=msg;
  clearInterval(timerInterval);
  rematchChosen=false;
  rematchModal.style.display='flex';
  // auto redirect after 5s
  setTimeout(()=>{ if(!rematchChosen) showLeaderboard(); },5000);
}

document.getElementById('rematchBtn').addEventListener('click',()=>{
  rematchChosen=true;
  rematchModal.style.display='none';
  payForRematch().then(success=>{
    if(success) resetBoard();
  });
});
document.getElementById('skipBtn').addEventListener('click',()=>{
  rematchChosen=true;
  rematchModal.style.display='none';
  showLeaderboard();
});

function payForRematch(){
  return new Promise(resolve=>{
    // placeholder for Pi payment API
    console.log('Trigger Pi payment for rematch...');
    setTimeout(()=>{ resolve(true); },1000);
  });
}

function resetBoard(){
  board = [
    ['bR','bN','bB','bQ','bK','bB','bN','bR'],
    ['bP','bP','bP','bP','bP','bP','bP','bP'],
    ['','','','','','','',''],
    ['','','','','','','',''],
    ['','','','','','','',''],
    ['','','','','','','',''],
    ['wP','wP','wP','wP','wP','wP','wP','wP'],
    ['wR','wN','wB','wQ','wK','wB','wN','wR']
  ];
  timer1=600; timer2=600; turn='w'; messageEl.textContent='';
  leaderboard.style.display='none';
  drawBoard();
  startTimers();
}

function showLeaderboard(){
  leaderboard.style.display='flex';
  drawBoard();
}

document.getElementById('backLobbyBtn').addEventListener('click',()=>{
  leaderboard.style.display='none';
  resetBoard();
});

// --- INIT ---
drawBoard();
startTimers();
</script>
</body>
</html>
